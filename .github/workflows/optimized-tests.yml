name: æœ€é©åŒ–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  analyze:
    name: å·®åˆ†åˆ†æžã¨ãƒ†ã‚¹ãƒˆè¨ˆç”»
    runs-on: ubuntu-latest
    outputs:
      affected_areas: ${{ steps.analyze.outputs.affected_areas }}
      test_plan: ${{ steps.analyze.outputs.test_plan }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Node.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: å¤‰æ›´å½±éŸ¿ç¯„å›²ã®åˆ†æž
        id: analyze
        run: |
          cd backend
          
          # å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- src/ tests/ | grep -v "node_modules")
          echo "å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«:"
          echo "$CHANGED_FILES"
          echo "::set-output name=changed_files::$(echo $CHANGED_FILES | tr ' ' ',')"
          
          # å½±éŸ¿ã‚’å—ã‘ã‚‹é ˜åŸŸã®ç‰¹å®š
          AFFECTED_AREAS="[]"
          
          if echo "$CHANGED_FILES" | grep -q "src/features/auth\|tests/.*auth"; then
            AFFECTED_AREAS=$(echo $AFFECTED_AREAS | jq '. + ["auth"]')
          fi
          
          if echo "$CHANGED_FILES" | grep -q "src/features/properties\|tests/.*properties"; then
            AFFECTED_AREAS=$(echo $AFFECTED_AREAS | jq '. + ["properties"]')
          fi
          
          if echo "$CHANGED_FILES" | grep -q "src/features/users\|tests/.*users"; then
            AFFECTED_AREAS=$(echo $AFFECTED_AREAS | jq '. + ["users"]')
          fi
          
          if echo "$CHANGED_FILES" | grep -q "src/features/organizations\|tests/.*organizations"; then
            AFFECTED_AREAS=$(echo $AFFECTED_AREAS | jq '. + ["organizations"]')
          fi
          
          if echo "$CHANGED_FILES" | grep -q "src/common\|src/config\|src/db\|src/types"; then
            AFFECTED_AREAS=$(echo $AFFECTED_AREAS | jq '. + ["core"]')
          fi
          
          # å¤‰æ›´ãŒãªã„å ´åˆã¯ã‚³ã‚¢ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
          if [ "$AFFECTED_AREAS" = "[]" ]; then
            AFFECTED_AREAS='["core"]'
          fi
          
          echo "å½±éŸ¿ã‚’å—ã‘ã‚‹é ˜åŸŸ: $AFFECTED_AREAS"
          echo "::set-output name=affected_areas::$AFFECTED_AREAS"
          
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œè¨ˆç”»ã®ä½œæˆ
          TEST_PLAN="{}"
          
          if echo "$AFFECTED_AREAS" | jq -e 'contains(["auth"])' > /dev/null; then
            TEST_PLAN=$(echo $TEST_PLAN | jq '. + {"auth": ["tests/integration/auth/**/*.test.ts"]}')
          fi
          
          if echo "$AFFECTED_AREAS" | jq -e 'contains(["properties"])' > /dev/null; then
            TEST_PLAN=$(echo $TEST_PLAN | jq '. + {"properties": ["tests/integration/properties/**/*.test.ts"]}')
          fi
          
          if echo "$AFFECTED_AREAS" | jq -e 'contains(["users"])' > /dev/null; then
            TEST_PLAN=$(echo $TEST_PLAN | jq '. + {"users": ["tests/integration/users/**/*.test.ts"]}')
          fi
          
          if echo "$AFFECTED_AREAS" | jq -e 'contains(["organizations"])' > /dev/null; then
            TEST_PLAN=$(echo $TEST_PLAN | jq '. + {"organizations": ["tests/integration/organizations/**/*.test.ts"]}')
          fi
          
          if echo "$AFFECTED_AREAS" | jq -e 'contains(["core"])' > /dev/null; then
            TEST_PLAN=$(echo $TEST_PLAN | jq '. + {"core": ["tests/unit/**/*.test.ts"]}')
          fi
          
          echo "ãƒ†ã‚¹ãƒˆè¨ˆç”»: $TEST_PLAN"
          echo "::set-output name=test_plan::$TEST_PLAN"

  test:
    needs: analyze
    name: åŠ¹çŽ‡çš„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    strategy:
      matrix:
        area: ${{ fromJSON(needs.analyze.outputs.affected_areas) }}
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Node.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd backend
          npm ci
      
      - name: .env ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
        run: |
          cd backend
          # GitHub Secretsã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
          cat > .env << EOF
          # è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆCIã§ã®å®Ÿè¡Œç”¨ï¼‰
          DATABASE_URL=${{ secrets.TEST_DATABASE_URL }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          # ä»–ã®å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ã“ã“ã«è¿½åŠ 
          EOF
      
      - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
        id: cache
        uses: actions/cache@v3
        with:
          path: |
            backend/.jest-cache
            backend/.test-results
          key: ${{ runner.os }}-tests-${{ matrix.area }}-${{ hashFiles('backend/package-lock.json') }}-${{ hashFiles('backend/src/features/**') }}
      
      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ¤œè¨¼
        run: |
          cd backend
          # TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
          npx tsc --noEmit
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šç¢ºèªï¼ˆNode.js ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ï¼‰
          node -e "
          const mongoose = require('mongoose');
          require('dotenv').config();
          
          async function checkConnection() {
            try {
              await mongoose.connect(process.env.DATABASE_URL);
              console.log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šæˆåŠŸ');
              await mongoose.disconnect();
              process.exit(0);
            } catch (error) {
              console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
              process.exit(1);
            }
          }
          
          checkConnection();
          "
      
      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          cd backend
          
          # å½±éŸ¿ã‚’å—ã‘ã‚‹é ˜åŸŸã®ã¿ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          TEST_PATTERN=$(echo '${{ needs.analyze.outputs.test_plan }}' | jq -r '.${{ matrix.area }}[]' | tr '\n' ' ')
          echo "å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³: $TEST_PATTERN"
          
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ - çµæžœã‚’JSONã«å‡ºåŠ›
          JEST_ARGS="--ci --maxWorkers=2 --json --outputFile=jest-results.json"
          if [ -n "$TEST_PATTERN" ]; then
            npx jest $TEST_PATTERN $JEST_ARGS || true
          else
            echo "ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
            npx jest $JEST_ARGS || true
          fi
      
      - name: ãƒ†ã‚¹ãƒˆçµæžœã®åˆ†æž
        run: |
          cd backend
          
          # ãƒ†ã‚¹ãƒˆçµæžœã®åˆ†æž
          if [ -f jest-results.json ]; then
            echo "ãƒ†ã‚¹ãƒˆçµæžœã‚’åˆ†æžä¸­..."
            npx ts-node tests/utils/test-analyzer.ts analyze --results-file jest-results.json
          else
            echo "ãƒ†ã‚¹ãƒˆçµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
          fi
      
      - name: ãƒ†ã‚¹ãƒˆçµæžœã®ä¿å­˜
        if: always()
        run: |
          cd backend
          mkdir -p .test-results
          
          if [ -f jest-results.json ]; then
            cp jest-results.json .test-results/${{ matrix.area }}-results.json
          fi
      
      - name: ãƒ†ã‚¹ãƒˆçŠ¶æ³ã®å ±å‘Š
        if: always()
        run: |
          cd backend
          
          if [ -f .test-results/${{ matrix.area }}-results.json ]; then
            # æˆåŠŸãƒ»å¤±æ•—ã®ä»¶æ•°ã‚’å‡ºåŠ›
            SUCCESS_COUNT=$(cat .test-results/${{ matrix.area }}-results.json | jq '.numPassedTests')
            FAILURE_COUNT=$(cat .test-results/${{ matrix.area }}-results.json | jq '.numFailedTests')
            TOTAL_COUNT=$(cat .test-results/${{ matrix.area }}-results.json | jq '.numTotalTests')
            
            echo "### ${{ matrix.area }} ãƒ†ã‚¹ãƒˆçµæžœ ðŸ“Š" >> $GITHUB_STEP_SUMMARY
            echo "- æˆåŠŸ: $SUCCESS_COUNT / $TOTAL_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- å¤±æ•—: $FAILURE_COUNT / $TOTAL_COUNT" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILURE_COUNT" -gt 0 ]; then
              echo "#### å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆ" >> $GITHUB_STEP_SUMMARY
              cat .test-results/${{ matrix.area }}-results.json | \
                jq -r '.testResults[] | select(.status == "failed") | .name + ": " + (.assertionResults | map(select(.status == "failed")) | .[0].fullName)' | \
                while read -r line; do
                  echo "- $line" >> $GITHUB_STEP_SUMMARY
                done
            fi
          else
            echo "### ${{ matrix.area }} ãƒ†ã‚¹ãƒˆçµæžœ âš ï¸" >> $GITHUB_STEP_SUMMARY
            echo "ãƒ†ã‚¹ãƒˆçµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" >> $GITHUB_STEP_SUMMARY
          fi