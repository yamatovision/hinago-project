# 垂直スライス実装計画書

## 1. 実装戦略概要

本プロジェクトでは、データの自然な格納順序に従い、垂直スライス方式で実装を進めます。各スライスはフロントエンドからバックエンドまでの一貫した機能単位で、独立してテスト・デプロイ可能です。

### 1.1 垂直スライスの定義
各スライスは以下の要素を含む完全な機能単位です：
* データモデル（データベーススキーマ）
* バックエンドAPI（コントローラ、サービス、リポジトリ）
* フロントエンドUI（画面、コンポーネント、状態管理）
* テスト（単体テスト、統合テスト）

### 1.2 データフロー中心アプローチ
実装順序はデータの自然な格納・参照順序に基づいて決定されます：
1. 基盤データ（ユーザー、組織、認証）
2. 中核ビジネスエンティティ（物件、形状データ）
3. 分析機能（ボリュームチェック、3Dモデル）
4. 拡張機能（収益性試算、シナリオ管理）
5. 補助機能（文書管理、履歴管理）

## 2. 垂直スライス一覧と実装順序

| 順序 | スライス名 | 主要機能 | 依存スライス | 優先度 | 見積工数 |
|-----|-----------|---------|------------|--------|---------|
| 1 | 認証基盤 | ユーザー登録・ログイン | なし | 最高 | 5人日 |
| 2 | 物件管理 | 物件登録・詳細表示 | 認証基盤 | 最高 | 7人日 |
| 3 | 敷地形状 | 測量図アップロード・形状編集 | 物件管理 | 高 | 8人日 |
| 4 | ボリュームチェック | 建築可能ボリューム計算 | 敷地形状 | 最高 | 10人日 |
| 5 | 3Dビジュアライゼーション | 建築ボリュームの3D表示 | ボリュームチェック | 高 | 8人日 |
| 6 | 収益性試算 | 事業収支シミュレーション | ボリュームチェック | 中 | 7人日 |
| 7 | シナリオ管理 | 複数条件の比較機能 | 収益性試算 | 中 | 5人日 |
| 8 | 文書管理 | 関連資料管理・共有機能 | 物件管理 | 低 | 4人日 |
| 9 | ダッシュボード | 案件一覧と概況表示 | すべて | 中 | 6人日 |

## 3. 詳細実装計画

### 3.1 スライス#1: 認証基盤

#### 対象エンティティ
* User
* Organization
* Token (リフレッシュトークン管理)

#### 機能範囲
* ユーザー登録
* ログイン/ログアウト
* パスワードリセット
* 基本プロフィール管理
* トークン更新

#### 実装タスク

**データベース層**
- [ ] Userスキーマ実装
- [ ] Organizationスキーマ実装
- [ ] Tokenスキーマ実装
- [ ] 初期マイグレーション作成
- [ ] シードスクリプト実装

**バックエンド層**
- [ ] 認証ミドルウェア実装
- [ ] AuthControllerの実装
- [ ] AuthServiceの実装
- [ ] JWTトークン生成・検証機能
- [ ] パスワードハッシュ化処理
- [ ] パスワードリセット機能
- [ ] アクセス制御基盤実装
- [ ] エラーハンドリング統一

**フロントエンド層**
- [ ] 認証コンテキスト実装
- [ ] ログイン画面実装
- [ ] 登録画面実装
- [ ] パスワードリセット画面実装
- [ ] トークン自動更新機能
- [ ] 保護されたルート実装
- [ ] エラーハンドリングUI

**テスト**
- [ ] ユーザーモデル単体テスト
- [ ] 認証サービス単体テスト
- [ ] 認証APIテスト
- [ ] トークン更新フローテスト
- [ ] フロントエンド認証フローテスト

### 3.2 スライス#2: 物件管理

#### 対象エンティティ
* Property
* History

#### 機能範囲
* 物件基本情報登録
* 物件一覧表示
* 物件詳細表示・編集
* 物件削除
* 変更履歴記録・表示

#### 実装タスク

**データベース層**
- [ ] Propertyスキーマ実装
- [ ] Historyスキーマ実装
- [ ] 位置情報インデックス設定

**バックエンド層**
- [ ] PropertyControllerの実装
- [ ] PropertyServiceの実装
- [ ] HistoryServiceの実装（変更記録）
- [ ] バリデーション実装
- [ ] 組織ベースのアクセス制御
- [ ] GeocodingService実装（住所→位置情報）

**フロントエンド層**
- [ ] 物件一覧画面実装
- [ ] 物件登録フォーム実装
- [ ] 物件詳細画面実装
- [ ] 物件編集フォーム実装
- [ ] 物件状態管理（Redux/Context）
- [ ] 物件フィルタリング・ソート機能
- [ ] 変更履歴表示コンポーネント

**テスト**
- [ ] 物件モデル単体テスト
- [ ] 物件サービス単体テスト
- [ ] 物件APIテスト
- [ ] フロントエンドCRUD操作テスト

### 3.3 スライス#3: 敷地形状

#### 対象エンティティ
* PropertyShape

#### 機能範囲
* 測量図アップロード
* 形状自動抽出
* 敷地形状手動編集
* 形状データ保存・読込

#### 実装タスク

**データベース層**
- [ ] PropertyShapeスキーマ実装
- [ ] ファイル保存ストレージ設定

**バックエンド層**
- [ ] ファイルアップロードハンドラ実装
- [ ] 測量図処理サービス実装
- [ ] PDF/DWG解析機能実装
- [ ] 形状抽出アルゴリズム実装
- [ ] 座標変換・正規化処理

**フロントエンド層**
- [ ] ファイルアップロードコンポーネント実装
- [ ] 形状エディタコンポーネント実装
- [ ] キャンバスベース編集インターフェース
- [ ] ドラッグ＆ドロップ機能
- [ ] プレビュー表示機能
- [ ] 形状データ状態管理

**テスト**
- [ ] 形状モデル単体テスト
- [ ] ファイル処理機能テスト
- [ ] 形状抽出機能テスト
- [ ] UI操作テスト

### 3.4 スライス#4: ボリュームチェック

#### 対象エンティティ
* VolumeCheck
* Floor

#### 機能範囲
* 建築条件設定
* 最大建築可能ボリューム計算
* 建築基準法規制適用
* 階別面積計算
* 容積消化率計算

#### 実装タスク

**データベース層**
- [ ] VolumeCheckスキーマ実装
- [ ] マスターデータ実装（アセットタイプ）

**バックエンド層**
- [ ] 建築基準法計算エンジン実装
- [ ] 法規制適用ロジック実装
- [ ] 斜線制限計算機能
- [ ] 日影規制計算機能
- [ ] 容積消化率計算機能
- [ ] 3Dモデルデータ生成機能
- [ ] PDFレポート生成機能

**フロントエンド層**
- [ ] 建築条件入力フォーム実装
- [ ] アセットタイプ選択UI
- [ ] 計算結果表示コンポーネント
- [ ] 容積消化率インジケータ
- [ ] 計算プロセス進行表示
- [ ] 結果保存・比較機能

**テスト**
- [ ] 計算エンジン単体テスト
- [ ] 各法規制計算テスト
- [ ] API統合テスト
- [ ] UIフロー検証

### 3.5 スライス#5: 3Dビジュアライゼーション

#### 対象エンティティ
* 特になし（VolumeCheckのmodel3dDataを使用）

#### 機能範囲
* 3Dモデル表示
* カメラ操作
* 敷地形状表示
* 建物ボリューム表示
* 3D表示設定

#### 実装タスク

**バックエンド層**
- [ ] 3Dモデルデータエンドポイント実装
- [ ] モデルフォーマット変換機能

**フロントエンド層**
- [ ] Three.js初期化・設定
- [ ] 3Dビューアコンポーネント実装
- [ ] 敷地形状3D表示
- [ ] 建物ボリューム3D表示
- [ ] カメラコントロール実装
- [ ] ライティング設定
- [ ] 視点プリセット機能
- [ ] パフォーマンス最適化

**テスト**
- [ ] 3Dビューア機能テスト
- [ ] パフォーマンステスト
- [ ] デバイス互換性テスト

### 3.6 スライス#6: 収益性試算

#### 対象エンティティ
* ProfitabilityResult

#### 機能範囲
* 収益パラメータ設定
* 事業収支計算
* 投資指標計算
* キャッシュフロー予測
* 結果表示・グラフ化

#### 実装タスク

**データベース層**
- [ ] ProfitabilityResultスキーマ実装

**バックエンド層**
- [ ] 収益計算エンジン実装
- [ ] 財務指標計算ロジック実装
- [ ] 長期キャッシュフロー生成
- [ ] 感度分析機能実装
- [ ] PDFレポート生成機能拡張

**フロントエンド層**
- [ ] 収益パラメータ入力UI
- [ ] パラメータスライダーコンポーネント
- [ ] 結果表示ダッシュボード
- [ ] 財務指標カード実装
- [ ] グラフ表示コンポーネント実装
- [ ] キャッシュフロー表示
- [ ] データエクスポート機能

**テスト**
- [ ] 収益計算エンジンテスト
- [ ] 財務指標計算検証
- [ ] APIテスト
- [ ] UI操作テスト

### 3.7 スライス#7: シナリオ管理

#### 対象エンティティ
* Scenario

#### 機能範囲
* 複数条件の保存
* シナリオ比較
* 最適パラメータ提案
* シナリオ共有

#### 実装タスク

**データベース層**
- [ ] Scenarioスキーマ実装

**バックエンド層**
- [ ] ScenarioControllerの実装
- [ ] ScenarioServiceの実装
- [ ] 比較機能APIエンドポイント実装
- [ ] シナリオ最適化機能

**フロントエンド層**
- [ ] シナリオ保存・管理UI
- [ ] シナリオ選択インターフェース
- [ ] シナリオ比較ビュー実装
- [ ] 差分ハイライト機能
- [ ] シナリオ名編集機能
- [ ] 削除・複製機能

**テスト**
- [ ] シナリオ管理機能テスト
- [ ] 比較機能テスト
- [ ] UI操作テスト

### 3.8 スライス#8: 文書管理

#### 対象エンティティ
* Document

#### 機能範囲
* 文書アップロード
* 文書カテゴリ分類
* 文書一覧表示
* 文書検索・ダウンロード

#### 実装タスク

**データベース層**
- [ ] Documentスキーマ実装
- [ ] ファイルストレージ連携設定

**バックエンド層**
- [ ] DocumentControllerの実装
- [ ] DocumentServiceの実装
- [ ] ファイルアップロード・ダウンロード
- [ ] 文書カテゴリ管理
- [ ] 文書検索機能

**フロントエンド層**
- [ ] 文書アップロードUI
- [ ] 文書一覧コンポーネント
- [ ] 文書カード表示
- [ ] プレビュー機能
- [ ] ダウンロード機能
- [ ] フィルタリング機能

**テスト**
- [ ] 文書管理機能テスト
- [ ] アップロード・ダウンロードテスト
- [ ] UI操作テスト

### 3.9 スライス#9: ダッシュボード

#### 対象エンティティ
* 複数エンティティの統合

#### 機能範囲
* 物件一覧表示
* クイックアクション
* 物件ステータス管理
* 最近の活動表示

#### 実装タスク

**バックエンド層**
- [ ] ダッシュボードデータAPIの実装
- [ ] サマリー機能実装
- [ ] 最近の活動取得機能

**フロントエンド層**
- [ ] ダッシュボードレイアウト実装
- [ ] 物件カードコンポーネント
- [ ] クイックアクションメニュー
- [ ] ステータスフィルター
- [ ] 活動タイムライン
- [ ] レスポンシブデザイン

**テスト**
- [ ] データ取得テスト
- [ ] UI表示テスト
- [ ] ユーザビリティテスト

## 4. クロスカッティング・コンサーン（横断的関心事）

以下の要素は複数スライスにまたがる共通機能として実装します：

### 4.1 ロギング
* **実装アプローチ**: winston + mongodb-transportの組み合わせ
* **優先度**: 中
* **実装タイミング**: 認証基盤と同時に実装
* **内容**:
  - 構造化ログ形式の採用
  - ログレベル別の出力制御
  - リクエストIDによるトレーサビリティ確保
  - 環境別ログ設定（開発環境は詳細、本番環境は重要ログのみ）

### 4.2 エラーハンドリング
* **実装アプローチ**: 集中型エラーハンドラーミドルウェア
* **優先度**: 高
* **実装タイミング**: 認証基盤と同時に実装
* **内容**:
  - 標準エラーレスポンス形式の定義
  - エラーコード体系の整備
  - フロントエンドでのグローバルエラーハンドリング
  - 開発環境での詳細エラー表示

### 4.3 キャッシュ戦略
* **実装アプローチ**: Redis + メモリキャッシュの階層型設計
* **優先度**: 低
* **実装タイミング**: 基本機能実装後
* **内容**:
  - 不変データのキャッシュ（マスターデータ等）
  - クエリ結果のキャッシュ（特にボリュームチェック結果）
  - キャッシュ無効化戦略
  - メモリ使用量監視

### 4.4 セキュリティ対策
* **実装アプローチ**: 各レイヤーでの対策実装
* **優先度**: 最高
* **実装タイミング**: 各スライス実装時に同時対応
* **内容**:
  - CSRF対策（Double Submit Cookie）
  - XSS対策（エスケープ、CSP）
  - CORS適切な設定
  - レート制限の実装

### 4.5 パフォーマンス最適化
* **実装アプローチ**: モニタリングと段階的最適化
* **優先度**: 中
* **実装タイミング**: 基本機能実装後
* **内容**:
  - DB クエリ最適化
  - インデックス戦略
  - フロントエンドバンドル最適化
  - 遅延読み込み実装

## 5. スライス間の統合ポイント

垂直スライス間の主要な統合ポイントを以下に示します：

| 統合ポイント | 関連スライス | 統合方法 | 実装タイミング |
|------------|------------|---------|-------------|
| ユーザー認証 | 認証基盤→すべてのスライス | JWTを使用したユーザーコンテキスト | 認証基盤実装後 |
| 物件参照 | 物件管理→他スライス | 物件IDによる参照、物件コンテキスト | 物件管理実装後 |
| 形状データ | 敷地形状→ボリュームチェック | 形状データの共有インターフェース | ボリュームチェック実装時 |
| 3Dモデル | ボリュームチェック→3Dビジュアライゼーション | model3dDataオブジェクト | 3Dビジュアライゼーション実装時 |
| 収益計算入力 | ボリュームチェック→収益性試算 | 計算結果の引き継ぎ | 収益性試算実装時 |
| シナリオデータ | 収益性試算→シナリオ管理 | シナリオパラメータ保存 | シナリオ管理実装時 |
| 文書リンク | 文書管理→物件管理 | 物件IDによる関連付け | 文書管理実装時 |
| ダッシュボード統合 | 全スライス→ダッシュボード | データ集約APIとコンポーネント | ダッシュボード実装時 |

## 6. リスクと対策

| リスク | 影響度 | 対策 |
|-------|-------|-----|
| 3Dモデル表示のパフォーマンス問題 | 高 | ・モデル複雑性の段階的増加<br>・LOD (Level of Detail)の実装<br>・モバイル向け軽量モード |
| 測量図形状抽出の精度問題 | 高 | ・複数の抽出アルゴリズムの組み合わせ<br>・手動補正機能の充実<br>・正確な座標系変換 |
| 建築基準法計算の法改正対応 | 中 | ・計算ロジックのモジュール化<br>・法規制パラメータのDB管理<br>・外部APIとの連携検討 |
| データベースパフォーマンス低下 | 中 | ・早期段階でのインデックス最適化<br>・クエリモニタリング導入<br>・シャーディング準備 |
| UI/UX設計の一貫性担保 | 中 | ・コンポーネントライブラリの整備<br>・デザインシステムの採用<br>・定期的なUXレビュー |
| スライス間の依存関係複雑化 | 低 | ・明確なインターフェース定義<br>・統合テストの充実<br>・依存関係図の継続的更新 |
| デプロイの複雑性 | 低 | ・CI/CDパイプラインの早期構築<br>・環境構成の標準化<br>・デプロイ自動化 |

## 7. 実装スケジュール

| フェーズ | 期間 | 対象スライス | マイルストーン |
|---------|------|------------|-------------|
| フェーズ1 | 2週間 | スライス#1 認証基盤 | 認証基盤完成 |
| フェーズ2 | 3週間 | スライス#2 物件管理<br>スライス#3 敷地形状 | 物件登録機能完成 |
| フェーズ3 | 4週間 | スライス#4 ボリュームチェック<br>スライス#5 3Dビジュアライゼーション | ボリュームチェック機能完成 |
| フェーズ4 | 3週間 | スライス#6 収益性試算<br>スライス#7 シナリオ管理 | 収益性分析機能完成 |
| フェーズ5 | 2週間 | スライス#8 文書管理<br>スライス#9 ダッシュボード | 補助機能完成 |
| フェーズ6 | 2週間 | 全スライス | テスト・バグ修正・最適化 |

## 8. 技術スタック選定

### 8.1 バックエンド
- **言語/フレームワーク**: Node.js + Express
- **データベース**: MongoDB
- **認証**: JWT + bcrypt
- **API形式**: RESTful API
- **ドキュメント**: OpenAPI (Swagger)
- **テスト**: Jest + Supertest

### 8.2 フロントエンド
- **言語/フレームワーク**: TypeScript + React
- **状態管理**: Redux Toolkit
- **ルーティング**: React Router
- **UI**: Material-UI
- **グラフ**: Chart.js
- **3D**: Three.js
- **テスト**: Jest + React Testing Library

### 8.3 デプロイ/インフラ
- **コンテナ化**: Docker
- **CI/CD**: GitHub Actions
- **デプロイ先**: AWS (ECS + MongoDB Atlas)
- **ストレージ**: S3
- **CDN**: CloudFront
- **監視**: CloudWatch + Sentry

## 9. テスト戦略

### 9.1 テスト階層
1. **単体テスト**: 各コンポーネント・サービスの独立テスト
2. **統合テスト**: APIエンドポイントとデータフローのテスト
3. **E2Eテスト**: ユーザーフロー全体のテスト

### 9.2 重点テスト領域
- 認証・認可フロー
- 建築基準法計算ロジック
- 3Dレンダリングパフォーマンス
- 財務計算精度

### 9.3 テスト自動化
- CIパイプラインでの自動テスト実行
- カバレッジレポート生成
- 重要フローのスモークテスト

## 10. まとめと次のステップ

本計画書で定義した垂直スライスアプローチに基づき、データの自然な流れに沿った実装を段階的に進めていきます。最初の認証基盤と物件管理機能の実装が全体の基礎となるため、特に丁寧な設計と実装が必要です。

### 10.1 直近の優先事項
1. 環境構築（開発・テスト）の完了
2. 認証基盤の実装
3. 物件管理機能の実装

### 10.2 成功指標
- 各スライスが独立してテスト・デプロイ可能
- クリアなデータフローと責任分離
- 拡張性の高いアーキテクチャ
- 高いテストカバレッジ

次のステップとして、認証基盤の詳細設計と実装に移行します。