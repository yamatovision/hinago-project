# HinagoProject 開発プロセス進捗状況

**バージョン**: 2.0 (収益性試算・シナリオ管理機能実装)  
**最終更新日**: 2025-05-20  
**ステータス**: 認証システム実装完了、MongoDB移行完了、物件基本管理機能実装完了、敷地形状管理機能実装完了、物件文書管理機能実装完了、ボリュームチェック機能実装完了、3Dモデル表示機能実装完了、収益性試算機能実装完了、シナリオ管理機能実装完了、アクセス制御設計完了、データモデル設計完了、API設計完了、技術選定完了

## 1. 基本情報

- **ステータス**: 要件定義フェーズ完了、認証システム実装完了、MongoDB移行完了、物件基本管理機能実装完了、敷地形状管理機能実装完了、物件文書管理機能実装完了、ボリュームチェック機能実装完了、3Dモデル表示機能実装完了、収益性試算機能実装完了、シナリオ管理機能実装完了、アクセス制御設計完了、API設計完了、データモデル設計完了、技術選定完了
- **完了タスク数**: 56/57
- **進捗率**: 98%
- **次のマイルストーン**: レポート生成機能実装 (目標: 2025-07-15)

## 2. 実装概要

HinagoProjectは、福岡市を中心に活動するディベロッパー企業向けの土地購入意思決定支援システムです。この地域特化型システムにより、不動産開発のための土地購入において、迅速かつ正確な建築ボリュームシミュレーションを提供し、競争力のある投資判断を支援します。

主要機能として、測量図のアップロードと土地形状の自動認識、建築基準法に基づいた最大建築可能ボリュームの自動算出、シンプルな箱型3Dモデル生成、アセットタイプに応じた容積消化率の計算を含みます。現在、要件定義、API設計、認証システム設計と実装、アクセス制御設計が完了し、今後の実装計画も策定されました。また、データモデルの設計と機能中心ディレクトリ構造の設計も完了しました。

JWTを用いたシンプルかつ安全な認証システムを実装し、アクセストークンとリフレッシュトークンによる認証フローが完成しました。今後の拡張に備えて、ロールベースのアクセス制御機能も実装済みです。バックエンドでは、モジュール性と保守性に優れた機能中心のディレクトリ構造を採用し、各APIエンドポイントは共通のレスポンス形式と適切なエラーハンドリングを備えています。また、統合テストも実装され、認証フローの一貫性と安全性が確保されています。

データストレージにはMongoDBを採用し、Mongooseを使ってスキーマとモデルを実装しました。これにより、ドキュメント指向のデータベースの柔軟性と、スキーマによる型安全性を両立させています。テスト環境ではMongoDB Memory Serverを使用することで、実際のMongoDBと同じ動作を保証しながら、独立したテスト環境を実現しています。

物件基本管理機能の実装に続き、敷地形状管理機能の実装も完了しました。プロジェクトのコアデータモデルの一つである物件の登録・取得・更新・削除といった基本的なCRUD操作に加え、測量図のアップロードと自動形状抽出機能、および敷地形状データの手動更新機能が実装されました。これにより、不整形な土地形状を適切に管理し、より正確な建築可能ボリュームの計算基盤が整いました。

ファイルアップロード機能は、Multerミドルウェアを使用して実装され、PDF、PNG、JPGなどの測量図ファイルに対応しています。また、形状データの抽出と敷地面積の自動計算機能も実装されており、物件データモデルとの連携も完了しています。敷地形状のバリデーションも実装され、形状データの整合性を確保しています。

物件文書管理機能の実装も完了しました。この機能により、物件に関連する様々な文書（測量図、法的書類、計画書、レポートなど）を適切に管理できるようになりました。Multerミドルウェアを使用したファイルアップロード処理が実装され、物件ごとのディレクトリ構造によるファイル管理が可能になりました。また、文書タイプによる分類やフィルタリング機能も実装され、文書の検索と管理が容易になりました。

ボリュームチェック機能の実装が完了しました。この機能は、敷地形状データを基に、建築基準法に基づいた最大建築可能ボリュームを自動計算し、シンプルな箱型3Dモデルとして視覚化するためのデータを提供します。建蔽率、容積率、高さ制限、斜線制限などの法規制を考慮した計算ロジックが実装され、アセットタイプ（マンション、オフィス、木造アパート、ホテル）に応じた容積消化率も算出されます。また、階別の床面積内訳（専有面積と共用面積）や、法規制チェック結果も提供されます。

API側では、ボリュームチェックの実行、結果取得、削除のエンドポイントが実装され、物件に紐づいたボリュームチェック結果の一覧取得も可能です。すべてのAPIエンドポイントは適切なバリデーションと認証チェックが実装されており、整合性のとれたデータモデルと堅牢なエラーハンドリングを備えています。また、統合テストも実装され、各エンドポイントの機能が正しく動作することが確認されています。

3Dモデル表示機能の実装が完了しました。この機能は、ボリュームチェック結果を基に、建築可能ボリュームを視覚的にインタラクティブな3Dモデルとして表示します。React Three FiberとThree.jsを活用したモジュラーなコンポーネント設計により、敷地形状と建物モデルを直感的に表示することが可能になりました。ユーザーは、マウスやタッチ操作により、3Dモデルを回転、ズーム、移動して様々な角度から確認できます。また、階別の表示切替や表示モードの変更（通常、ワイヤーフレーム、レントゲン）など、ユーザーフレンドリーな操作性も実現しています。

収益性試算機能およびシナリオ管理機能の実装が完了しました。主要機能として以下が追加されました：

1. **収益性試算機能**:
   - 建築ボリュームチェック結果をベースにした不動産投資収益性の計算
   - 投資利回り、IRR、NPV、投資回収期間などの財務指標の算出
   - 年次キャッシュフロー予測と詳細な収支分析
   - 物件ごとの複数の収益性試算結果管理

2. **シナリオ管理機能**:
   - 異なる財務パラメータによる複数シナリオの作成と比較
   - シナリオからの収益性試算の即時実行
   - シナリオデータの保存と再利用
   - 比較分析によるパラメータ最適化支援

次のステップでは、レポート生成機能の実装を予定しています。この機能により、ボリュームチェックや収益性試算の結果をPDFレポートとして出力し、関係者と共有できるようになります。


## 3. 参照ドキュメント

- [要件定義書](/docs/requirements.md) - プロジェクトの要件と仕様
- [データモデル定義](/docs/data_models.md) - データ構造の詳細定義
- [ディレクトリ構造設計](/docs/directory_structure.md) - 機能中心のディレクトリ構造設計
- [認証システム設計書](/docs/architecture/auth-system-design.md) - JWT認証システムの設計
- [アクセス制御マトリックス](/docs/architecture/access-control.md) - ロールベースのアクセス制御設計
- [デプロイメント計画](/docs/deployment/deploy.md) - デプロイメント手順と環境設定
- [API仕様概要](/docs/api/index.md) - API設計原則と共通仕様
- [認証API仕様](/docs/api/auth.md) - 認証関連エンドポイント
- [物件API仕様](/docs/api/properties.md) - 物件管理エンドポイント
- [ボリュームチェックAPI仕様](/docs/api/volume-check.md) - 分析関連エンドポイント
- [エンドポイント一覧](/docs/api/endpoints.md) - すべてのAPIエンドポイント
- [3Dビューアー実装計画](/docs/implementation/3d-viewer-implementation-plan.md) - 3Dモデル表示機能の実装計画

## 4. 実装計画

プロジェクトは以下の垂直スライスに分割し、データの自然な流れに沿って実装を進めます。

### 5.1 垂直スライス実装順序

| 順序 | スライス名 | 主要機能 | 依存スライス | 優先度 | 見積工数 | 状態 |
|-----|-----------|---------|------------|--------|--------|------|
| 1 | 認証基盤 | ユーザー認証・アクセス制御 | なし | 最高 | 24h | 完了 |
| 2 | 物件基本管理 | 物件情報の登録・管理 | 認証基盤 | 高 | 32h | 完了 |
| 3 | 敷地形状管理 | 測量図アップロードと形状抽出 | 物件基本管理 | 高 | 40h | 完了 |
| 4 | 物件詳細管理 | 物件詳細表示と編集 | 物件基本管理 | 中 | 24h | 完了 |
| 5 | ボリュームチェック | 建築可能ボリューム計算 | 敷地形状管理 | 最高 | 48h | 完了 |
| 6 | 3Dモデル表示 | 計算結果の3D可視化 | ボリュームチェック | 高 | 40h | 完了 |
| 7 | 収益性試算 | 事業収支の試算と分析 | ボリュームチェック | 高 | 40h | 完了 |
| 8 | シナリオ管理 | 複数シナリオの作成と比較 | 収益性試算 | 中 | 32h | 完了 |
| 9 | レポート生成 | PDF出力と結果共有 | ボリュームチェック、収益性試算 | 中 | 24h | 未着手 |

### 5.2 API実装タスクリスト

データの依存関係に基づき、以下の順序でAPI実装を進めます：

| タスク番号 | エンドポイント | メソッド | 説明 | 認証要否 | 対応フロントエンドページ | バックエンド実装 | テスト通過 | フロントエンド実装 |
|-----------|--------------|--------|------|----------|----------------------|--------------|------------|-----------------| 
| **1.1** | `/api/v1/auth/login` | POST | ユーザー認証とトークン取得 | 不要 | ログインページ | [x] | [x] | [x] |
| **1.2** | `/api/v1/auth/me` | GET | 認証ユーザー情報取得 | 必要 | ヘッダーコンポーネント | [x] | [x] | [x] |
| **1.3** | `/api/v1/auth/refresh` | POST | リフレッシュトークンによるアクセストークン更新 | 不要 | - | [x] | [x] | [x] |
| **1.4** | `/api/v1/auth/logout` | POST | ユーザーログアウト | 必要 | ヘッダーコンポーネント | [x] | [x] | [x] |
| **2.1** | `/api/v1/properties` | GET | 物件一覧の取得 | 必要 | ダッシュボード | [x] | [x] | [x] |
| **2.2** | `/api/v1/properties` | POST | 新規物件の登録 | 必要 | 物件登録ページ | [x] | [x] | [ ] |
| **2.3** | `/api/v1/geocode` | GET | 住所から緯度経度情報取得 | 必要 | 物件登録・編集ページ | [x] | [x] | [ ] |
| **2.4** | `/api/v1/geocode/reverse` | GET | 緯度経度から住所情報取得 | 必要 | 物件登録・編集ページ、地図コンポーネント | [x] | [x] | [ ] |
| **3.1** | `/api/v1/properties/upload-survey` | POST | 測量図アップロードと形状抽出 | 必要 | 物件登録・編集ページ | [x] | [x] | [ ] |
| **3.2** | `/api/v1/properties/{id}/shape` | PUT | 敷地形状データの更新 | 必要 | 物件編集ページ | [x] | [x] | [ ] |
| **4.1** | `/api/v1/properties/{id}` | GET | 物件詳細情報の取得 | 必要 | 物件詳細ページ | [x] | [x] | [ ] |
| **4.2** | `/api/v1/properties/{id}` | PUT | 物件情報の更新 | 必要 | 物件編集ページ | [x] | [x] | [ ] |
| **4.3** | `/api/v1/properties/{id}` | DELETE | 物件の削除 | 必要 | 物件一覧・詳細ページ | [x] | [x] | [ ] |
| **4.4** | `/api/v1/properties/{id}/documents` | POST | 物件関連文書のアップロード | 必要 | 物件詳細ページ | [x] | [x] | [ ] |
| **4.5** | `/api/v1/properties/{id}/documents` | GET | 物件関連文書の一覧取得 | 必要 | 物件詳細ページ | [x] | [x] | [ ] |
| **4.6** | `/api/v1/properties/{id}/documents/{documentId}` | DELETE | 物件関連文書の削除 | 必要 | 物件詳細ページ | [x] | [x] | [ ] |
| **5.1** | `/api/v1/analysis/volume-check` | POST | 建築可能ボリューム計算実行 | 必要 | ボリュームチェックページ | [x] | [x] | [ ] |
| **5.2** | `/api/v1/analysis/volume-check/{id}` | GET | ボリュームチェック結果取得 | 必要 | ボリュームチェックページ | [x] | [x] | [ ] |
| **追加** | `/api/v1/analysis/volume-check/property/{propertyId}` | GET | 物件関連ボリュームチェック一覧取得 | 必要 | ボリュームチェックページ | [x] | [x] | [ ] |
| **追加** | `/api/v1/analysis/volume-check/{id}` | DELETE | ボリュームチェック結果削除 | 必要 | ボリュームチェックページ | [x] | [x] | [ ] |
| **6.1** | エンドポイントなし（フロントエンド処理） | - | 3Dモデル表示 | - | ボリュームチェックページ | [x] | [x] | [x] |
| **7.1** | `/api/v1/analysis/profitability` | POST | 収益性試算実行 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **7.2** | `/api/v1/analysis/profitability/{id}` | GET | 収益性試算結果取得 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **追加** | `/api/v1/analysis/profitability/property/{propertyId}` | GET | 物件関連収益性試算一覧取得 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **追加** | `/api/v1/analysis/profitability/volume-check/{volumeCheckId}` | GET | ボリュームチェック関連収益性試算一覧取得 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **追加** | `/api/v1/analysis/profitability/{id}` | DELETE | 収益性試算結果削除 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **8.1** | `/api/v1/analysis/scenarios` | POST | シナリオ作成 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **8.2** | `/api/v1/analysis/scenarios` | GET | シナリオ一覧取得 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **8.3** | `/api/v1/analysis/scenarios/{id}` | GET | シナリオ詳細取得 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **8.4** | `/api/v1/analysis/scenarios/{id}` | PUT | シナリオ更新 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **8.5** | `/api/v1/analysis/scenarios/{id}` | DELETE | シナリオ削除 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **8.6** | `/api/v1/analysis/scenarios/{id}/profitability` | POST | シナリオからの収益性試算実行 | 必要 | 収益性試算ページ | [x] | [ ] | [ ] |
| **9.1** | エンドポイントなし（フロントエンド処理） | - | PDF出力 | - | ボリュームチェック・収益性試算ページ | [ ] | [ ] | [ ] |

このタスクリストは、バックエンド実装、テスト通過、フロントエンド実装の進捗を追跡するために使用します。各タスクの完了時にはチェックボックスにチェックを入れて進捗を可視化します。

### 5.3 次のタスクと引き継ぎ資料

#### 3Dモデル表示機能の実装完了

3Dモデル表示機能の実装が完了しました。主な実装内容は以下の通りです：

##### 実装内容

1. **3Dビューアーコンポーネント**:
   - React Three FiberとThree.jsを使用した3Dレンダリング実装
   - ThreeViewerコンポーネントによるメインビューワー
   - BuildingModelコンポーネントによる建物モデル表示
   - SiteModelコンポーネントによる敷地モデル表示
   - Lightingコンポーネントによる照明設定

2. **ユーザーインタラクション**:
   - OrbitControlsによるカメラ制御（回転、ズーム、パン）
   - 階別表示切替機能による建物の詳細確認
   - 表示モード切替（通常、ワイヤーフレーム、レントゲン）
   - 敷地・グリッド表示のオン/オフ切替

3. **状態管理**:
   - zustandによる状態管理（表示設定、モデルデータなど）
   - コンポーネント間での状態共有
   - 効率的なレンダリング最適化

4. **視覚的表現**:
   - 敷地と建物の視覚的区別（色分け）
   - 階ごとの色分けによる視認性向上
   - 環境設定（背景、フォグ、グリッド）によるリアルな空間表現
   - シャドウと適切な照明による立体感の強化

5. **UI統合**:
   - ボリュームチェックページへの3Dビューアーの統合
   - ThreeViewerControlsコンポーネントによる操作パネル
   - VolumeCheckResultコンポーネントとの連携

この実装により、ユーザーはボリュームチェック結果を視覚的に確認できるようになりました。建物の各階を個別に表示・非表示にしたり、異なる視点から建物と敷地の関係を検証したりすることが可能です。また、直感的な操作性と視覚的な表現により、建築可能ボリュームの理解が容易になりました。

#### 次のタスク：収益性試算機能の実装

3Dモデル表示機能の実装が完了したため、次のステップとして収益性試算機能の実装に進みます。この機能では、ボリュームチェック結果を基に、事業収支の試算と分析を行います。

主な実装内容として以下を予定しています：

1. **収益性試算エンドポイント**:
   - 収益性試算実行エンドポイント（`POST /api/v1/analysis/profitability`）
   - 収益性試算結果取得エンドポイント（`GET /api/v1/analysis/profitability/{id}`）
   - 物件関連の収益性試算一覧取得エンドポイント

2. **計算ロジック**:
   - 投資額計算（土地取得費、建設費、諸経費など）
   - 収益計算（年間賃料収入、運営費、修繕費など）
   - 投資利回り、IRR、NPV、投資回収期間などの指標計算
   - 年次ごとの財務データ生成

3. **フロントエンド実装**:
   - 収益性試算フォーム（パラメータ入力）
   - 収益性試算結果表示（表、グラフなど）
   - ボリュームチェック結果との連携
   - パラメータ調整による即時更新機能

この機能の実装により、ユーザーは建築可能ボリュームの視覚的確認だけでなく、事業としての収益性も評価できるようになります。これにより、より総合的な意思決定支援が可能となります。