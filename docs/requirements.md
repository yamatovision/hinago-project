# ボリュームチェックシステム 要件定義書

**バージョン**: 1.4.0  
**最終更新日**: 2025-05-19  
**ステータス**: ドラフト  

## 1. プロジェクト概要

### 1.1 目的と背景

福岡市を中心に31年の歴史を持つディベロッパー企業向けの、土地購入意思決定支援システムです。近年の福岡市内における土地不足により、良質な投資用地をめぐる競争が激化しています。これにより、土地購入判断における迅速性と正確性の両立が経営上の課題となっています。

本システムは、建築基準法や都市計画法に基づいた最大建築可能ボリュームの自動算出を中心とした機能を提供し、現在属人的に行われている土地購入判断プロセスを迅速化します。特に3Dモデルによる視覚的な把握と容積消化率の最適化により、投資効率の高い判断を支援します。

### 1.2 ターゲットユーザー

- **不動産ディベロッパー経営者**: 最終的な投資判断を行う意思決定者
- **用地仕入れ担当者**: 土地情報を収集・分析し、購入候補を選定する担当者
- **設計・企画担当者**: 土地に対する建築計画を立案する担当者

### 1.3 核となる機能と価値

以下は、プロジェクトの本質的価値を提供するために「絶対に必要」な機能です。各機能は「この機能がないとプロジェクトの目的達成が不可能になる」という基準で厳選されています。

- **建築基準法に基づく最大ボリュームチェック機能**: 敷地情報と法規制に基づいた最大建築可能ボリュームを自動算出 - *この機能がないと土地の最大活用可能性が不明確となり、投資判断の基礎が欠如する*
- **測量図アップロードと土地形状読み込み機能**: 不整形な土地の形状を正確に反映し、現実的な建築可能ボリュームを算出 - *この機能がないと長方形や正方形以外の土地形状に対応できず、正確な計算結果が得られない*
- **シンプルな箱型3Dモデル生成機能**: 算出された建築ボリュームを視覚的に表現し直感的な理解を促進 - *この機能がないと空間的な把握が困難となり、実現性の判断が不正確になる*
- **容積消化率の自動計算機能**: アセットタイプ（マンション、木造アパート等）に応じた容積消化率を算出 - *この機能がないと現実的な建築計画ベースでの収益性判断ができず、投資効率が不明確になる*

### 1.4 認証・アクセス制御システム

効率的なチーム作業と機密データ保護のため、以下の認証・アクセス制御機能を実装します：

- **JWTベースの認証システム**: ステートレスでスケーラブルな認証メカニズムを採用
- **シンプルな権限構造**: 初期フェーズではADMINロールのみを実装し、後続フェーズでロールベースのアクセス制御を拡張
- **セキュアなトークン管理**: HttpOnly Cookieによるトークン保存と適切なCSRF対策
- **リフレッシュトークンフロー**: アクセストークンの期限切れ時に自動更新するメカニズム
- **保護されたAPI**: すべてのデータ操作APIは認証済みユーザーのみアクセス可能



## 2. 画面一覧

このアプリケーションは以下の画面要素と実際のページで構成されます。各ページのモックアップは作成後に詳細化されます。

### 2.1 画面要素一覧

以下は機能的に必要な全ての画面要素です。これらは必ずしも独立したページとして実装されるわけではありません。

| 画面要素名 | 目的 | 実現する核心的価値 |
|----------|------|----------------|
| ログインフォーム要素 | ユーザー認証の実施 | セキュアなアクセス制御の確保 |
| 敷地情報入力要素 | 対象土地の基本情報登録 | 正確なデータ入力基盤の確保 |
| 測量図アップロード要素 | 土地の正確な形状情報の取得 | 不整形地に対応した正確な計算基盤の確保 |
| アセットタイプ選択要素 | 建物種別の選択 | 現実的な建築プラン策定 |
| ボリュームチェック要素 | 建築可能ボリュームの自動算出表示 | 最大建築可能規模の可視化 |
| 3D表示要素 | 生成された建築ボリュームの3D表示 | 空間的な把握と直感的理解 |
| 容積消化率表示要素 | 選択アセットタイプの容積消化率表示 | 実現可能な建築ボリュームの効率評価 |
| PDF出力要素 | 分析結果のPDFレポート生成 | 関係者間での情報共有と会議資料作成 |
| 案件一覧要素 | 登録済み案件の一覧表示と管理 | 複数案件の比較と進捗管理 |

### 2.2 ページ構成計画

上記の画面要素を、ユーザー体験とナビゲーション効率を最適化するために以下のように統合・構成します。必要に応じてサブシステム別にページをグループ化して示します。

#### 2.2.1 認証サブシステム

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| S1-001 | ログインページ | 既存ユーザーの認証 | ログインフォーム要素 | 最高 | [login.html](/mockups/login.html) | 未着手 |

#### 2.2.2 共通ページ

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| P-001 | ダッシュボード | 全体概況と案件一覧 | 案件一覧要素 | 高 | [dashboard.html](/mockups/dashboard.html) | 未着手 |

#### 2.2.3 物件管理サブシステム

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| S2-001 | 物件登録ページ | 新規物件情報の登録 | 敷地情報入力要素、測量図アップロード要素 | 高 | [property-register.html](/mockups/property-register.html) | 未着手 |
| S2-002 | 物件詳細ページ | 登録済み物件の詳細表示と編集 | 敷地情報入力要素、測量図アップロード要素 | 中 | [property-detail.html](/mockups/property-detail.html) | 未着手 |

#### 2.2.4 分析サブシステム

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| S3-001 | ボリュームチェックページ | 建築可能ボリュームの算出と表示 | 敷地情報入力要素、測量図アップロード要素、アセットタイプ選択要素、ボリュームチェック要素、3D表示要素、容積消化率表示要素、PDF出力要素 | 最高 | [volume-check.html](/mockups/volume-check.html) | 未着手 |
| S3-002 | 収益性試算ページ | 事業収支の試算と分析 | 敷地情報入力要素、アセットタイプ選択要素、ボリュームチェック要素、収益性試算要素 | 高 | [profitability-analysis.html](/mockups/profitability-analysis.html) | 未着手 |

### 2.3 画面フロー

サブシステムごとのナビゲーションフローを示します。

#### 2.3.1 認証フロー
```
[ログインページ] → [認証成功] → [ダッシュボード]
```

#### 2.3.2 物件登録フロー
```
[ダッシュボード] → [物件登録ページ] → [測量図アップロード] → [登録完了後、ボリュームチェックページまたはダッシュボードへ]
```

#### 2.3.3 分析フロー
```
[ダッシュボード] → [物件選択] → [ボリュームチェックページ] → [必要に応じて収益性試算ページ]
```

## 3. ページ詳細

このセクションでは、各サブシステムに含まれるページの詳細と、それらに含まれる画面要素について説明します。

### 3.1 認証サブシステム

#### 3.1.1 ログインページ (S1-001)

**ページ概要**: ユーザー認証のためのインターフェースを提供します。シンプルながらセキュアなログイン機能を実装しています。

**含まれる画面要素**:
- ログインフォーム要素: メールアドレスとパスワードの入力フォーム
- エラーメッセージ表示要素: 認証失敗時の適切なフィードバック
- ログイン状態保持オプション: 「ログイン状態を保持する」チェックボックス

**状態と動作**:
- 初期状態: 空のログインフォームの表示
- 入力状態: メールアドレスとパスワードの入力
- 検証状態: 入力データのバリデーション結果表示
- エラー状態: 認証失敗時のエラーメッセージ表示
- 成功状態: 認証成功後、ダッシュボードへリダイレクト

**データとAPI**:
- `POST /api/auth/login` → ユーザー認証
  - リクエスト: { email: string, password: string, rememberMe?: boolean }
  - 成功: { user: { id: string, email: string, name: string, role: string }, token: string }
  - エラー: 401 Unauthorized

### 3.2 共通ページ

#### 3.2.1 ダッシュボード (P-001)

**ページ概要**: システムのメインハブとして機能し、登録済み物件一覧と主要機能へのアクセスを提供します。

**含まれる画面要素**:
- 案件一覧要素: 登録済み物件の一覧表示とフィルタリング機能
- クイックアクション要素: よく使う機能へのショートカット
- ユーザーメニュー要素: 認証済みユーザー情報とログアウト機能

**状態と動作**:
- 初期状態: 登録済み物件一覧の表示
- フィルタ状態: 条件によるフィルタリング結果の表示
- アクション状態: 選択物件に対する操作メニューの表示

**データとAPI**:
- `GET /api/properties` → 物件一覧取得
  - リクエスト: { filters?: FilterOptions }
  - 成功: { properties: Property[] }
  - エラー: 401 Unauthorized, 403 Forbidden

### 3.3 物件管理サブシステム

#### 3.3.1 物件登録ページ (S2-001)
**モックアップ**: [property-register.html](/mockups/property-register.html)

**ページ概要**: 新規物件情報を登録するためのインターフェースを提供します。シンプルでクリーンなUI設計により、データ入力の効率性と正確性を両立しています。

**含まれる画面要素**:
- 敷地情報入力要素: 物件基本情報の入力フォーム（住所、敷地面積、用途地域、防火地域区分、日影規制、建蔽率、容積率、許容建築面積）
- 測量図アップロード要素: 測量図のアップロードと土地形状の自動/手動設定機能
- 地図プレビュー要素: 住所から自動生成される地図表示（Google Maps、Mapbox GL、Leaflet.jsなどを使用）
- 折りたたみ可能な詳細規制情報セクション: 情報過多による認知負荷を軽減するUI

**状態と動作**:
- 初期状態: 空の登録フォームと必須項目の表示
- 入力状態: 物件情報入力中の状態。自動計算機能による即時フィードバック（許容建築面積や坪単価）
- 測量図アップロード状態: 測量図のアップロードと形状抽出処理中
- 形状調整状態: 抽出された土地形状の確認・調整
- 検証状態: 入力データのバリデーション結果表示
- 完了状態: 登録完了確認と次ステップへの誘導

**UI最適化ポイント**:
- 必須項目と任意項目の明確な区別（必須項目にはアスタリスク表示）
- セクション分割による情報の構造化（基本情報、法規制情報、備考・メモ）
- 詳細情報の折りたたみ表示による認知負荷の低減
- リアルタイム計算による即時フィードバック（許容建築面積や坪単価の自動計算）
- モバイル対応のレスポンシブデザイン

**データとAPI**:
- `POST /api/properties` → 新規物件登録
  - リクエスト: { propertyData: PropertyCreateData, shapeData?: ShapeData }
  - 成功: { property: Property }
  - エラー: 400 Bad Request
- `POST /api/properties/upload-survey` → 測量図アップロード
  - リクエスト: FormData (file: File)
  - 成功: { shapeData: ShapeData }
  - エラー: 400 Bad Request
- `GET /api/geocode` → 住所から緯度経度情報取得
  - リクエスト: { address: string }
  - 成功: { lat: number, lng: number, formatted_address: string }
  - エラー: 400 Bad Request

#### 3.3.2 物件詳細ページ (S2-002)
**モックアップ**: [property-detail.html](/mockups/property-detail.html)

**ページ概要**: 登録済み物件の詳細表示と編集を提供します。タブインターフェースにより、基本情報、敷地形状、図面・資料、更新履歴などを効率的に管理できます。

**含まれる画面要素**:
- 敷地情報入力要素: 物件基本情報の入力/編集フォーム（物件名、住所、敷地面積、用途地域など）
- 測量図アップロード要素: 測量図のアップロードと土地形状の設定機能
- 敷地形状エディタ: 境界点座標の表示と編集機能
- 資料管理要素: 関連図面や書類のアップロード、表示、ダウンロード機能
- タグ管理要素: 物件の特性をタグとして管理する機能
- 更新履歴表示要素: 物件情報の変更履歴を時系列で表示

**状態と動作**:
- 初期状態: 既存物件情報をタブ形式で表示
- 編集状態: 物件情報の編集中状態。リアルタイム計算による即時フィードバック
- 測量図アップロード状態: 測量図のアップロードと形状抽出処理中
- 形状調整状態: 抽出された土地形状の確認・調整
- 資料管理状態: 関連図面や書類の追加、削除、プレビュー
- 保存状態: 編集内容の検証と保存完了確認

**UI最適化ポイント**:
- タブインターフェースによる情報の整理（基本情報、敷地形状、図面・資料、更新履歴）
- ステータスバッジによる物件状態の視覚的表現
- 必須項目と任意項目の明確な区別
- 敷地形状の視覚的表現と編集
- 関連資料の一元管理とプレビュー機能
- 更新履歴の時系列表示による変更追跡
- モバイル対応のレスポンシブデザイン

**データとAPI**:
- `GET /api/properties/:id` → 物件詳細取得
  - リクエスト: { id: string }
  - 成功: { property: PropertyDetail }
  - エラー: 404 Not Found
- `PUT /api/properties/:id` → 物件情報更新
  - リクエスト: { id: string, propertyData: PropertyUpdateData }
  - 成功: { property: PropertyDetail }
  - エラー: 400 Bad Request
- `POST /api/properties/:id/documents` → 資料アップロード
  - リクエスト: FormData (file: File)
  - 成功: { document: Document }
  - エラー: 400 Bad Request
- `GET /api/properties/:id/history` → 更新履歴取得
  - リクエスト: { id: string, limit?: number }
  - 成功: { history: HistoryEntry[] }
  - エラー: 404 Not Found

### 3.4 分析サブシステム

#### 3.4.1 ボリュームチェックページ (S3-001)

**ページ概要**: 建築基準法を考慮した最大建築可能ボリュームを自動算出し視覚化します。アセットタイプ選択により容積消化率も表示します。

**含まれる画面要素**:
- 敷地情報入力要素: 物件基本情報の入力/編集フォーム
- 測量図アップロード要素: 測量図のアップロードと土地形状の設定機能
- アセットタイプ選択要素: マンション、木造アパート、オフィスなどの選択ボタン
- ボリュームチェック要素: 建築条件の設定と自動計算機能
- 3D表示要素: 計算結果の3Dビジュアライゼーション（箱型モデル）
- 容積消化率表示要素: 選択アセットタイプに基づく容積消化率の表示
- PDF出力要素: 分析結果のPDF出力機能

**状態と動作**:
- 初期状態: 基本パラメータ入力フォームの表示
- 測量図アップロード状態: 測量図のアップロードと形状抽出処理中
- 形状調整状態: 抽出された土地形状の確認・調整
- 計算中状態: 処理進行状況インジケータの表示
- 結果表示状態: 算出結果と3Dビューの表示
- 編集状態: パラメータ変更による再計算と結果更新

**データとAPI**:
- `POST /api/analysis/volume-check` → ボリュームチェック実行
  - リクエスト: { propertyId: string, buildingParams: BuildingParams, assetType: string }
  - 成功: { volumeResult: VolumeCheckResult, consumptionRate: number, model3d: Model3DData }
  - エラー: 400 Bad Request
- `POST /api/properties/upload-survey` → 測量図アップロード
  - リクエスト: FormData (file: File)
  - 成功: { shapeData: ShapeData }
  - エラー: 400 Bad Request
- `PUT /api/properties/:id/shape` → 土地形状の手動更新
  - リクエスト: { id: string, shapeData: ShapeData }
  - 成功: { property: PropertyDetail }
  - エラー: 400 Bad Request

#### 3.4.2 収益性試算ページ (S3-002)
**モックアップ**: [profitability-analysis.html](/mockups/profitability-analysis.html)

**ページ概要**: ボリュームチェック結果に基づき、事業収支を自動試算します。複数シナリオの比較分析が可能で、投資判断に必要な財務指標を提供します。

**含まれる画面要素**:
- 敷地情報要素: 物件基本情報の表示（非編集）
- ボリュームチェック要素: 建築ボリューム結果の表示（非編集）
- アセットタイプ選択要素: マンション、木造アパート、オフィスなどの選択ボタン
- 収益性パラメータ設定要素: 収益性試算のための詳細パラメータ設定（賃料単価、稼働率、建設単価など）
- シナリオ管理要素: 複数シナリオの作成・比較機能
- 結果表示要素: 投資利回り、IRR、NPV、投資回収期間などの財務指標
- グラフ表示要素: キャッシュフロー推移と感度分析のグラフ
- PDF出力要素: 分析結果のPDF出力機能

**状態と動作**:
- 初期状態: 基本パラメータ入力フォームとボリュームチェック結果の表示
- パラメータ調整状態: スライダーによる収益パラメータの直感的調整
- シナリオ切替状態: 複数シナリオ間の切り替えと比較
- 計算中状態: 処理進行状況インジケータの表示
- 結果表示状態: 収支計算結果の表・グラフ表示
- 編集状態: パラメータ変更による再計算と結果更新

**UI最適化ポイント**:
- スライダーによる直感的なパラメータ調整
- 即時フィードバックによる影響の可視化
- シナリオタブによる複数ケースの簡単な比較
- 階層化された情報表示（カードとタブの組み合わせ）
- 視覚的に理解しやすいデータグラフと指標表示
- モバイル対応のレスポンシブデザイン

**データとAPI**:
- `POST /api/analysis/profitability` → 収益性試算実行
  - リクエスト: { propertyId: string, volumeId: string, assetType: string, financialParams: FinancialParams }
  - 成功: { profitabilityResult: ProfitabilityResult }
  - エラー: 400 Bad Request
- `POST /api/analysis/scenarios` → シナリオ保存
  - リクエスト: { propertyId: string, name: string, params: ScenarioParams }
  - 成功: { scenario: Scenario }
  - エラー: 400 Bad Request
- `GET /api/analysis/scenarios` → シナリオ一覧取得
  - リクエスト: { propertyId: string }
  - 成功: { scenarios: Scenario[] }
  - エラー: 404 Not Found

## 4. 共通コンポーネント

| ID | コンポーネント名 | 用途 | 使用ページ | 参照 |
|----|--------------|------|----------|------|
| C-001 | ヘッダーナビゲーション | 全画面共通のナビゲーションバー | 全ページ | - |
| C-002 | ログインフォーム | ユーザー認証UI | ログインページ | - |
| C-003 | 保護されたルート | 認証状態に基づくルート保護 | 全保護ページ | - |
| C-004 | ユーザーメニュー | ユーザー情報表示とログアウト | 全認証済みページ | - |
| C-005 | 物件選択ドロップダウン | 登録済み物件からの選択UI | ダッシュボード、分析ページ群 | - |
| C-006 | 測量図アップローダー | 測量図のアップロードと形状抽出 | 物件登録ページ、ボリュームチェックページ | - |
| C-007 | 土地形状エディタ | 土地形状の手動調整インターフェース | 物件登録ページ、ボリュームチェックページ | - |
| C-008 | 3Dビューアコンポーネント | 建築ボリュームの3D表示 | ボリュームチェックページ | - |
| C-009 | 容積消化率インジケータ | 容積消化率の視覚的表示 | ボリュームチェックページ | - |
| C-010 | アセットタイプセレクタ | 建物種別の選択UI | ボリュームチェックページ、収益性試算ページ | - |
| C-011 | パラメータスライダー | 収益性パラメータの直感的調整 | 収益性試算ページ | - |
| C-012 | シナリオタブシステム | 複数シナリオの保存と切替 | 収益性試算ページ | - |
| C-013 | データメトリクスカード | 主要指標のカード表示 | 収益性試算ページ、ボリュームチェックページ | - |
| C-014 | マップビューアコンポーネント | 物件位置の地図表示 | 物件登録ページ、物件詳細ページ | - |

## 5. データモデル概要

データモデルの詳細は `docs/data_models.md` で定義されています。すべての型定義は `shared/index.ts` で一元管理され、フロントエンドとバックエンドで共有されます。

### 5.1 エンティティ関連図

```
       User (ユーザー)
        |
        +----------------+-------------+-------------+-------------+-------------+
        |                |             |             |             |             |
        v                v             v             v             v             v
  RefreshToken        Property     VolumeCheck    Scenario    ProfitabilityResult  Document
 (リフレッシュトークン)  (物件)    (ボリュームチェック) (シナリオ)  (収益性試算結果)    (文書)
                        |
                        |
                        v                     
                  PropertyShape              
                   (敷地形状)                
                                    
      Property (物件)
        |
        +------------+------------+
        |            |            |
        v            v            v
  PropertyShape  VolumeCheck   Document
  (敷地形状)    (ボリュームチェック)  (文書)
                    |
                    v
                 Scenario
                (シナリオ)
                    |
                    v
              ProfitabilityResult
              (収益性試算結果)
```

### 5.2 主要エンティティ

| エンティティ | 主な属性 | 関連エンティティ | 備考 |
|------------|----------|----------------|------|
| User | id, email, name, password, role, createdAt, updatedAt | - | ユーザー情報 |
| RefreshToken | id, userId, token, expiresAt, createdAt | User | リフレッシュトークン情報 |
| Property | id, name, address, area, zoneType, fireZone, shadowRegulation, buildingCoverage, floorAreaRatio, allowedBuildingArea, shapeData, price, status, notes, userId, createdAt, updatedAt | User, VolumeCheck, Document | 物件基本情報 |
| PropertyShape | points, width, depth, sourceFile | Property | 土地形状情報 |
| VolumeCheck | id, propertyId, assetType, buildingArea, totalFloorArea, buildingHeight, consumptionRate, floors, model3dData, userId, createdAt, updatedAt | Property, User | ボリュームチェック結果 |
| Scenario | id, propertyId, volumeCheckId, name, params, profitabilityResult, userId, createdAt, updatedAt | Property, VolumeCheck, User | 収益性試算シナリオ |
| ProfitabilityResult | id, propertyId, volumeCheckId, assetType, parameters, landPrice, constructionCost, miscExpenses, totalInvestment, annualRentalIncome, annualOperatingExpenses, annualMaintenance, annualPropertyTax, annualNOI, noiYield, irr, paybackPeriod, npv, annualFinancials, userId, createdAt, updatedAt | Property, VolumeCheck, User | 収益性試算結果 |
| Document | id, propertyId, name, fileType, fileSize, fileUrl, documentType, description, userId, createdAt, updatedAt | Property, User | 文書情報 |

## 5.3 API仕様概要

API仕様の詳細は `docs/api/` ディレクトリ内のドキュメントで定義されています。システムはRESTful APIアーキテクチャを採用し、一貫性のある直感的なインターフェースを提供します。

### 5.3.1 API設計原則

- **ベースURL**: `/api/v1/` （将来的な拡張を考慮してバージョン番号を含む）
- **リソース指向設計**: リソースに対する操作をHTTPメソッドで表現
- **HTTPメソッド**: GET（取得）、POST（作成）、PUT（更新）、PATCH（部分更新）、DELETE（削除）
- **標準レスポンス形式**: すべてのAPIが一貫した成功/エラーレスポンス形式を使用
- **クエリパラメータ**: フィルタリング、ソート、ページネーションに統一的なパラメータを使用

### 5.3.2 認証方式

- **JWTベース認証**: アクセストークン（有効期限15分）による認証
- **リフレッシュトークン**: 長期間（7日）有効なトークンによるアクセストークン再発行
- **セキュア保存**: HttpOnly Cookieによるトークン保存
- **認証除外**: ログインと認証更新エンドポイントのみ認証不要

### 5.3.3 主要APIエンドポイント

| カテゴリ | 主要エンドポイント | 概要 |
|---------|-------------------|------|
| 認証 | `/api/v1/auth/login` | ユーザー認証とトークン取得 |
| 認証 | `/api/v1/auth/me` | 認証ユーザー情報取得 |
| 認証 | `/api/v1/auth/refresh` | トークン更新 |
| 物件 | `/api/v1/properties` | 物件一覧取得/登録 |
| 物件 | `/api/v1/properties/{id}` | 物件詳細取得/更新/削除 |
| 物件 | `/api/v1/properties/upload-survey` | 測量図アップロードと形状抽出 |
| 分析 | `/api/v1/analysis/volume-check` | ボリュームチェック実行 |
| 分析 | `/api/v1/analysis/profitability` | 収益性試算実行 |
| 分析 | `/api/v1/analysis/scenarios` | シナリオ管理 |

詳細なAPI仕様は以下のドキュメントを参照してください：
- [API仕様概要](/docs/api/index.md) - API設計原則と共通仕様
- [認証API仕様](/docs/api/auth.md) - 認証関連のエンドポイント
- [物件API仕様](/docs/api/properties.md) - 物件管理のエンドポイント
- [ボリュームチェックAPI仕様](/docs/api/volume-check.md) - 分析関連のエンドポイント
- [エンドポイント一覧](/docs/api/endpoints.md) - すべてのAPIエンドポイント

## 6. 特記すべき非機能要件

以下は標準的な実装方針から特に注意すべき点です：

- **セキュリティ対策**: 業務用不動産データを扱うため、認証・認可の厳格な実装と適切なCSRF対策が必須
- **トークン管理**: JWTトークンの安全な保存（HttpOnly Cookie）と適切な有効期限設定（15分）
- **認証エラー処理**: ユーザーに詳細なエラー情報を漏らさない適切なエラーメッセージの設計
- **計算処理の応答性**: ボリュームチェックなど計算負荷の高い処理についても、10秒以内の応答を目標
- **3D表示の軽量性**: 3Dビューアはモバイルデバイスを含む様々な環境でも動作する軽量な実装が必要
- **建築基準法の正確な反映**: 福岡市の建築基準法規制を正確に計算に反映させる必要がある
- **測量図解析の精度**: 一般的なPDFや画像形式の測量図から正確に土地形状を抽出する精度が重要
- **形状編集のユーザビリティ**: 複雑な土地形状も直感的に編集できるインターフェースが必要
- **PDF出力の品質**: 出力されるPDFは印刷用途にも適した高品質なものである必要がある

## 6.1 技術的実装方針

### 6.1.1 3Dモデル表示技術

**フェーズ1（初期実装）: Three.js**
- 軽量かつシンプルな3Dモデル表示に最適
- 多くのデバイスでの互換性確保
- 基本的な箱型ボリューム表示と敷地形状表現に適している
- モバイルデバイスを含む様々な環境での動作を保証

**フェーズ2（拡張）: Cesiumへの段階的移行検討**
- 地理情報と連携した高品質な3D表示
- 地形データや周辺建物との関係性表現
- 厳密な緯度経度ベースでの配置と計算
- プレゼンテーション品質の向上

**開発アプローチ**
- モジュール化された設計により、表示エンジンの差し替えを容易にする
- コアロジック（計算エンジン）とビジュアライゼーション層を分離
- パフォーマンスを考慮したハイブリッド実装（重い計算はサーバーサイド）

### 6.1.2 測量図処理技術

**自動処理と手動調整の組み合わせ**
- DWG/DXF形式からの座標情報の自動抽出
- PDFからのOCRと形状認識技術の組み合わせ
- ユーザーによる手動補正インターフェースの提供
- 抽出結果の検証と調整メカニズム

**必要なデータ連携**
- 緯度経度情報との紐付け
- 地形データ（標高）との統合
- 地域の都市計画情報との自動照合
- 規制情報データベースとの連携

### 6.1.3 計算処理アーキテクチャ

**バックエンド計算エンジン**
- 複雑な法規制計算（斜線制限、日影規制等）はサーバーサイドで実行
- 計算結果のキャッシュ機構による応答速度の最適化
- バッチ処理とリアルタイム処理の使い分け

**フロントエンド処理**
- 軽量な再計算と表示の更新
- インタラクティブな操作に対する即時フィードバック
- WebWorkerを活用した非同期処理

### 6.1.4 地図表示コンポーネント

**実装アプローチ**
- マップライブラリ導入: Google Maps JavaScript API、Mapbox GL JS、またはLeaflet.jsを使用
- コンポーネント設計: 現在のMapPlaceholderを実際の地図コンポーネントに置き換え
- ピン表示機能: ジオコーディング結果の緯度・経度を使って物件位置をマップ上にピン表示
- 周辺環境表示: 物件周辺の地形、道路、建物などを地図上に表示
- モバイル対応: タッチ操作とレスポンシブ設計に対応した実装

**API連携**
- ジオコーディングAPIとの連携: 住所入力時に自動的に緯度・経度情報を取得
- 地図APIとの連携: 取得した位置情報を基に地図を表示
- 地図情報のデータモデル連携: 位置情報を物件データモデルの一部として保存

**フェーズ分け実装**
- フェーズ1: 基本的な地図表示と物件位置のピン表示
- フェーズ2: 地図操作機能の拡充（ズーム、パン、衛星写真表示など）
- フェーズ3: 周辺環境情報の追加表示（公共交通機関、施設など）
- フェーズ4: 複数物件の同時表示と比較機能

### 6.1.5 収益性試算エンジン

**パラメータ管理システム**
- スライダーベースの直感的なパラメータ調整UI
- プリセットによる一般的なシナリオの素早い適用
- 過去のプロジェクトからのパラメータ自動提案機能
- リアルタイムな市場データとの連携オプション

**シナリオ比較システム**
- 複数シナリオの同時保存と管理
- 差分ハイライト機能による比較の容易化
- 感度分析グラフによるパラメータ影響の可視化
- 最適パラメータの自動提案機能

**レポート生成システム**
- 印刷用高品質PDFレポート生成
- 複数シナリオの一括比較レポート
- カスタマイズ可能なレポートテンプレート
- 企業ロゴや連絡先情報の自動埋め込み

## 7. システム構成とディレクトリ構造

詳細なディレクトリ構造は `docs/directory_structure.md` で定義されています。本プロジェクトでは、技術的な層ではなく、ビジネス機能を中心としたディレクトリ構造を採用しています。

### 7.1 システム全体構成

```
/HinagoProject/
├── docs/                   # プロジェクトドキュメント
├── mockups/                # UIモックアップ
├── shared/                 # 共有型定義とAPIパス
├── frontend/               # フロントエンドアプリケーション
├── backend/                # バックエンドアプリケーション
└── scripts/                # ビルドスクリプトや開発用ツール
```

### 7.2 バックエンド構造概要

```
/backend/
├── src/
│   ├── common/            # 全機能で共有する共通コード
│   ├── features/          # 機能ごとにグループ化
│   │   ├── properties/    # 物件管理機能
│   │   ├── volume-check/  # ボリュームチェック機能
│   │   └── profitability/ # 収益性試算機能
│   ├── config/           # アプリケーション設定
│   ├── db/               # データベース関連
│   └── app.ts            # アプリケーションエントリーポイント
└── tests/                # テスト
```

### 7.3 フロントエンド構造概要

```
/frontend/
├── public/              # 静的ファイル
└── src/
    ├── common/          # 共通コンポーネント・ユーティリティ
    ├── features/        # 機能ごとにグループ化
    │   ├── dashboard/   # ダッシュボード機能
    │   ├── properties/  # 物件管理機能
    │   ├── volume-check/ # ボリュームチェック機能
    │   └── profitability/ # 収益性試算機能
    ├── app/             # アプリケーションのコア
    └── index.tsx        # エントリーポイント
```

### 7.4 アプリケーション層設計の原則

1. **単一責任の原則**: 各コンポーネントは明確に定義された単一の責任を持つ
2. **ディレクトリ=機能**: 各ディレクトリは特定のビジネス機能を表す
3. **共通コードの抽象化**: 複数の機能で使用されるコードは `common` ディレクトリに抽象化
4. **型定義の一元管理**: すべての型定義は `shared/index.ts` で管理
5. **APIパスの一元管理**: すべてのAPIパスは `shared/index.ts` で管理
6. **共有コードは上流へ**: 複数の機能でコードの共有が必要になった場合は、上位の共通層へ移動

## 8. 開発計画とマイルストーン

| フェーズ | 内容 | 期間 | ステータス |
|---------|------|------|----------| 
| フェーズ1 | 要件定義・技術選定 | 2週間 | 進行中 |
| フェーズ2 | モックアップ作成・ユーザーインターフェース設計 | 2週間 | 開始予定 |
| フェーズ3 | データモデル設計・API設計 | 2週間 | 未着手 |
| フェーズ4 | 基本機能実装（物件管理） | 3週間 | 未着手 |
| フェーズ5 | 測量図アップロードと形状抽出機能実装 | 3週間 | 未着手 |
| フェーズ6 | ボリュームチェック機能実装（Three.js） | 3週間 | 未着手 |
| フェーズ7 | 3Dモデル生成・容積消化率計算機能実装 | 3週間 | 未着手 |
| フェーズ8 | テスト・バグ修正 | 2週間 | 未着手 |
| フェーズ9 | ベータリリース・フィードバック収集 | 2週間 | 未着手 |
| フェーズ10 | 改善・正式リリース | 2週間 | 未着手 |
| フェーズ11 | （オプション）Cesiumへの移行検討・POC | 3週間 | 未着手 |

## 9. 添付資料

- [ボリュームチェックページモックアップ](/mockups/volume-check.html) - 主要機能のモックアップ
- [物件登録ページモックアップ](/mockups/property-register.html) - 物件情報登録のモックアップ
- [収益性試算ページモックアップ](/mockups/profitability-analysis.html) - 収益性分析のモックアップ
- [ダッシュボードモックアップ](/mockups/dashboard.html) - ダッシュボード画面のモックアップ

## 10. データフロー図

### 10.1 測量図処理フロー

```
[測量図アップロード] → [形式判定] → [適切な処理経路選択]
    │
    ├→ [DWG/DXF処理] → [座標抽出] → [敷地形状生成]
    │
    ├→ [PDF処理] → [OCR/画像認識] → [境界線抽出] → [座標変換] → [敷地形状生成]
    │
    └→ [画像処理] → [画像認識] → [境界線抽出] → [座標変換] → [敷地形状生成]
                                                       │
                                                       V
[敷地情報入力] → [地理情報連携] → [規制情報取得] → [検証・調整UI] → [確定敷地データ]
```

### 10.2 3Dモデル生成フロー

```
[確定敷地データ] → [アセットタイプ選択] → [計算パラメータ設定]
                                          │
                                          V
[バックエンド] → [法規制適用計算] → [最大建築可能ボリューム算出] → [階別データ生成]
                                                                  │
                                                                  V
[フロントエンド] → [Three.js初期化] → [敷地モデル生成] → [建物モデル生成] → [3D表示]
                                                                        │
                                                                        V
                                                    [容積消化率計算] → [結果表示]
```

### 10.3 収益性分析フロー

```
[ボリュームチェック結果] → [アセットタイプ選択] → [収益パラメータ設定]
                                                   │
                                                   V
[収益計算エンジン] → [年間収益計算] → [長期キャッシュフロー予測] → [財務指標算出]
                                                                  │
                                                                  V
[シナリオ管理] ←────────────────────────────────────────┬──→ [結果表示]
      ↑                                               │
      │                                               V
      └───────────────────────────────── [感度分析] → [グラフ生成]
```

### 10.4 データ連携図

```
[福岡市都市計画API] ───┐
                      │
[国土地理院標高API] ───┼─→ [データ統合レイヤー] ←─┬─── [測量図処理エンジン]
                      │                       │
[建築基準法DB] ────────┘                       └─── [ユーザー入力データ]
                                               │
                                               V
               ┌─────────────────────── [建築ボリューム計算エンジン]
               │                               │
               V                               V
    [Three.js可視化エンジン] ←─────────── [結果分析エンジン]
               │                               │
               └───────────────┐               │
                              V               V
                     [ユーザーインターフェース/レポート生成]
```