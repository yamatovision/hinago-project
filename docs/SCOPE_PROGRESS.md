# HinagoProject 開発プロセス進捗状況

**バージョン**: 1.5 (型定義更新版)  
**最終更新日**: 2025-05-19  
**ステータス**: 認証システム実装完了、MongoDB移行完了、物件基本管理機能実装完了、アクセス制御設計完了、データモデル設計完了、API設計完了、技術選定完了

## 1. 基本情報

- **ステータス**: 要件定義フェーズ完了、認証システム実装完了、MongoDB移行完了、物件基本管理機能実装完了、アクセス制御設計完了、API設計完了、データモデル設計完了、技術選定完了
- **完了タスク数**: 42/50
- **進捗率**: 84%
- **次のマイルストーン**: 敷地形状管理機能実装 (目標: 2025-06-10)

## 2. 実装概要

HinagoProjectは、福岡市を中心に活動するディベロッパー企業向けの土地購入意思決定支援システムです。この地域特化型システムにより、不動産開発のための土地購入において、迅速かつ正確な建築ボリュームシミュレーションを提供し、競争力のある投資判断を支援します。

主要機能として、測量図のアップロードと土地形状の自動認識、建築基準法に基づいた最大建築可能ボリュームの自動算出、シンプルな箱型3Dモデル生成、アセットタイプに応じた容積消化率の計算を含みます。現在、要件定義、API設計、認証システム設計と実装、アクセス制御設計が完了し、今後の実装計画も策定されました。また、データモデルの設計と機能中心ディレクトリ構造の設計も完了しました。

JWTを用いたシンプルかつ安全な認証システムを実装し、アクセストークンとリフレッシュトークンによる認証フローが完成しました。今後の拡張に備えて、ロールベースのアクセス制御機能も実装済みです。バックエンドでは、モジュール性と保守性に優れた機能中心のディレクトリ構造を採用し、各APIエンドポイントは共通のレスポンス形式と適切なエラーハンドリングを備えています。また、統合テストも実装され、認証フローの一貫性と安全性が確保されています。

データストレージにはMongoDBを採用し、Mongooseを使ってスキーマとモデルを実装しました。これにより、ドキュメント指向のデータベースの柔軟性と、スキーマによる型安全性を両立させています。テスト環境ではMongoDB Memory Serverを使用することで、実際のMongoDBと同じ動作を保証しながら、独立したテスト環境を実現しています。

物件基本管理機能の実装も完了し、プロジェクトのコアデータモデルの一つである物件の登録・取得・更新・削除といった基本的なCRUD操作が可能になりました。また、ジオコーディング機能も実装し、住所から緯度経度情報を取得できるようになりました。これにより、フロントエンドでの地図表示機能の実装が容易になります。次のステップでは、敷地形状管理機能に進み、測量図のアップロードと敷地形状データの登録・更新機能を実装する予定です。エンドポイント一覧に示されている通り、物件管理、ボリュームチェック、収益性試算などの主要機能を順次実装し、整合性のとれたAPIと堅牢なバックエンドシステムを構築していきます。

## 3. ディレクトリ構造（最終系）

```
/HinagoProject/
├── docs/                   # プロジェクトドキュメント
│   ├── requirements.md     # 要件定義書
│   ├── data_models.md      # データモデル定義
│   ├── directory_structure.md # 本ドキュメント
│   ├── SCOPE_PROGRESS.md   # スコープ進捗状況
│   └── deployment/         # デプロイメント関連ドキュメント
│
├── mockups/                # UIモックアップ
│   ├── dashboard.html      # ダッシュボード画面
│   ├── property-register.html # 物件登録画面
│   ├── property-detail.html # 物件詳細画面
│   ├── volume-check.html   # ボリュームチェック画面
│   └── profitability-analysis.html # 収益性試算画面
│
├── shared/                 # 共有型定義とAPIパス
│   └── index.ts            # 型定義・APIパスの単一の真実源
│
├── frontend/               # フロントエンドアプリケーション
│
├── backend/                # バックエンドアプリケーション
│
└── scripts/                # ビルドスクリプトや開発用ツール
```

## フロントエンド構造

```
/frontend/
├── public/                # 静的ファイル
│   ├── index.html         # メインHTMLファイル
│   ├── favicon.ico        # アプリケーションアイコン
│   └── assets/            # 画像などの静的アセット
│
└── src/
    ├── common/            # 共通コンポーネント・ユーティリティ
    │   ├── components/    # 汎用UIコンポーネント
    │   │   ├── Button/    # ボタンコンポーネント
    │   │   ├── Card/      # カードコンポーネント
    │   │   ├── Form/      # フォームコンポーネント
    │   │   ├── Layout/    # レイアウトコンポーネント
    │   │   ├── Loading/   # ローディングインジケータ
    │   │   └── ...        # その他の共通コンポーネント
    │   │
    │   ├── hooks/         # 共通Reactフック
    │   │   ├── useForm.ts # フォーム管理フック
    │   │   ├── useApi.ts  # API通信フック
    │   │   ├── useAuth.ts # 認証状態管理フック
    │   │   └── ...        # その他の共通フック
    │   │
    │   └── utils/         # ユーティリティ関数
    │       ├── api.ts     # API通信ユーティリティ
    │       ├── validation.ts # バリデーションユーティリティ
    │       ├── token.ts   # トークン管理ユーティリティ
    │       └── ...        # その他のユーティリティ
    │
    ├── features/          # 機能ごとにグループ化
    │   ├── auth/          # 認証機能
    │   │   ├── components/ # 認証関連コンポーネント
    │   │   │   ├── LoginForm/ # ログインフォーム
    │   │   │   ├── RegisterForm/ # 登録フォーム
    │   │   │   └── ProtectedRoute/ # 保護されたルート
    │   │   ├── hooks/     # 認証関連フック
    │   │   ├── pages/     # 認証関連ページ
    │   │   │   ├── LoginPage.tsx # ログインページ
    │   │   │   └── RegisterPage.tsx # 登録ページ
    │   │   ├── contexts/  # 認証コンテキスト
    │   │   │   └── AuthContext.tsx # 認証状態管理コンテキスト
    │   │   ├── services/  # 認証関連サービス
    │   │   │   └── tokenService.ts # トークン管理サービス
    │   │   └── api.ts     # 認証API連携
    │   │
    │   ├── dashboard/     # ダッシュボード機能
    │   │   ├── components/ # ダッシュボード固有のコンポーネント
    │   │   ├── hooks/     # ダッシュボード固有のフック
    │   │   ├── pages/     # ダッシュボード画面
    │   │   └── api.ts     # ダッシュボードAPI連携
    │   │
    │   ├── properties/    # 物件管理機能
    │   │   ├── components/ # 物件管理固有のコンポーネント
    │   │   │   ├── PropertyForm/ # 物件フォームコンポーネント
    │   │   │   ├── PropertyList/ # 物件一覧コンポーネント
    │   │   │   └── ...     # その他の物件関連コンポーネント
    │   │   ├── hooks/      # 物件管理固有のフック
    │   │   ├── pages/      # 物件管理画面
    │   │   │   ├── PropertyListPage.tsx # 物件一覧ページ
    │   │   │   ├── PropertyRegisterPage.tsx # 物件登録ページ
    │   │   │   └── PropertyDetailPage.tsx # 物件詳細ページ
    │   │   └── api.ts      # 物件管理API連携
    │   │
    │   ├── volume-check/  # ボリュームチェック機能
    │   │   ├── components/ # ボリュームチェック固有のコンポーネント
    │   │   │   ├── AssetTypeSelector/ # アセットタイプ選択コンポーネント
    │   │   │   ├── Model3DViewer/    # 3Dモデルビューアコンポーネント
    │   │   │   ├── SurveyMapUploader/ # 測量図アップローダーコンポーネント
    │   │   │   └── ...     # その他のボリュームチェック関連コンポーネント
    │   │   ├── hooks/      # ボリュームチェック固有のフック
    │   │   ├── pages/      # ボリュームチェック画面
    │   │   └── api.ts      # ボリュームチェックAPI連携
    │   │
    │   └── profitability/ # 収益性試算機能
    │       ├── components/ # 収益性試算固有のコンポーネント
    │       ├── hooks/      # 収益性試算固有のフック
    │       ├── pages/      # 収益性試算画面
    │       └── api.ts      # 収益性試算API連携
    │
    ├── app/               # アプリケーションのコア
    │   ├── routes.tsx     # ルーティング設定
    │   ├── providers.tsx  # コンテキストプロバイダー
    │   └── store.ts       # グローバル状態管理
    │
    └── index.tsx          # エントリーポイント
```

## バックエンド構造

```
/backend/
├── src/
│   ├── common/            # 全機能で共有する共通コード
│   │   ├── middlewares/   # 共通ミドルウェア
│   │   │   ├── auth.middleware.ts     # 認証ミドルウェア
│   │   │   ├── error.middleware.ts    # エラーハンドリングミドルウェア
│   │   │   └── validation.middleware.ts # バリデーションミドルウェア
│   │   │
│   │   ├── utils/         # ユーティリティ
│   │   │   ├── logger.ts   # ロギングユーティリティ
│   │   │   └── response.ts # レスポンスフォーマットユーティリティ
│   │   │
│   │   └── validators/    # 共通バリデーター
│   │       └── common.validator.ts # 共通バリデーションルール
│   │
│   ├── features/          # 機能ごとにグループ化
│   │   ├── auth/          # 認証機能
│   │   │   ├── auth.controller.ts   # 認証コントローラー
│   │   │   ├── auth.service.ts      # 認証サービス
│   │   │   ├── auth.routes.ts       # 認証ルート定義
│   │   │   ├── auth.middleware.ts   # 認証固有ミドルウェア
│   │   │   ├── auth.utils.ts        # 認証ユーティリティ
│   │   │   ├── auth.validator.ts    # 認証バリデーター
│   │   │   └── auth.config.ts       # JWT設定などの認証設定
│   │   │
│   │   ├── properties/    # 物件管理機能
│   │   │   ├── properties.controller.ts # コントローラー
│   │   │   ├── properties.service.ts    # サービス
│   │   │   ├── properties.routes.ts     # ルート定義
│   │   │   ├── properties.repository.ts # リポジトリ
│   │   │   └── properties.validator.ts  # バリデーター
│   │   │
│   │   ├── volume-check/  # ボリュームチェック機能
│   │   │   ├── volume-check.controller.ts # コントローラー
│   │   │   ├── volume-check.service.ts    # サービス
│   │   │   ├── volume-check.routes.ts     # ルート定義
│   │   │   ├── volume-check.repository.ts # リポジトリ
│   │   │   └── volume-check.validator.ts  # バリデーター
│   │   │
│   │   └── profitability/ # 収益性試算機能
│   │       ├── profitability.controller.ts # コントローラー
│   │       ├── profitability.service.ts    # サービス
│   │       ├── profitability.routes.ts     # ルート定義
│   │       ├── profitability.repository.ts # リポジトリ
│   │       └── profitability.validator.ts  # バリデーター
│   │
│   ├── config/           # アプリケーション設定
│   │   ├── app.config.ts  # アプリケーション設定
│   │   ├── auth.config.ts # 認証・JWT設定
│   │   └── index.ts       # 設定エクスポート
│   │
│   ├── db/               # データベース関連
│   │   ├── connection.ts  # データベース接続
│   │   └── models/        # データモデル
│   │       ├── User.ts        # ユーザーモデル
│   │       ├── schemas/       # Mongooseスキーマ
│   │       │   ├── user.schema.ts       # ユーザースキーマ
│   │       │   └── refreshToken.schema.ts # リフレッシュトークンスキーマ
│   │       ├── RefreshToken.ts # リフレッシュトークンモデル
│   │       ├── Property.ts     # 物件モデル
│   │       ├── VolumeCheck.ts  # ボリュームチェックモデル
│   │       ├── Document.ts     # 文書モデル
│   │       └── Scenario.ts     # シナリオモデル
│   │
│   ├── types/            # 型定義（shared/index.tsからコピー）
│   │   └── index.ts       # 型定義
│   │
│   ├── routes.ts         # ルートインデックス
│   │
│   └── app.ts            # アプリケーションエントリーポイント
│
└── tests/                # テスト
    ├── integration/      # 統合テスト
    │   ├── auth/         # 認証機能のテスト
    │   ├── properties/   # 物件管理機能のテスト
    │   ├── volume-check/ # ボリュームチェック機能のテスト
    │   └── profitability/ # 収益性試算機能のテスト
    │
    ├── unit/             # ユニットテスト
    │   ├── auth/         # 認証機能のテスト
    │   ├── properties/   # 物件管理機能のテスト
    │   ├── volume-check/ # ボリュームチェック機能のテスト
    │   └── profitability/ # 収益性試算機能のテスト
    │
    └── utils/            # テスト用ユーティリティ
        ├── db-test-helper.ts # データベーステスト用ヘルパー
        └── test-auth-helper.ts # 認証テスト用ヘルパー
```

## 4. 参照ドキュメント

- [要件定義書](/docs/requirements.md) - プロジェクトの要件と仕様
- [データモデル定義](/docs/data_models.md) - データ構造の詳細定義
- [ディレクトリ構造設計](/docs/directory_structure.md) - 機能中心のディレクトリ構造設計
- [認証システム設計書](/docs/architecture/auth-system-design.md) - JWT認証システムの設計
- [アクセス制御マトリックス](/docs/architecture/access-control.md) - ロールベースのアクセス制御設計
- [デプロイメント計画](/docs/deployment/deploy.md) - デプロイメント手順と環境設定
- [API仕様概要](/docs/api/index.md) - API設計原則と共通仕様
- [認証API仕様](/docs/api/auth.md) - 認証関連エンドポイント
- [物件API仕様](/docs/api/properties.md) - 物件管理エンドポイント
- [ボリュームチェックAPI仕様](/docs/api/volume-check.md) - 分析関連エンドポイント
- [エンドポイント一覧](/docs/api/endpoints.md) - すべてのAPIエンドポイント

## 5. 実装計画

プロジェクトは以下の垂直スライスに分割し、データの自然な流れに沿って実装を進めます。

### 5.1 垂直スライス実装順序

| 順序 | スライス名 | 主要機能 | 依存スライス | 優先度 | 見積工数 |
|-----|-----------|---------|------------|--------|--------|
| 1 | 認証基盤 | ユーザー認証・アクセス制御 | なし | 最高 | 24h |
| 2 | 物件基本管理 | 物件情報の登録・管理 | 認証基盤 | 高 | 32h |
| 3 | 敷地形状管理 | 測量図アップロードと形状抽出 | 物件基本管理 | 高 | 40h |
| 4 | 物件詳細管理 | 物件詳細表示と編集 | 物件基本管理 | 中 | 24h |
| 5 | ボリュームチェック | 建築可能ボリューム計算 | 敷地形状管理 | 最高 | 48h |
| 6 | 3Dモデル表示 | 計算結果の3D可視化 | ボリュームチェック | 高 | 40h |
| 7 | 収益性試算 | 事業収支の試算と分析 | ボリュームチェック | 高 | 40h |
| 8 | シナリオ管理 | 複数シナリオの作成と比較 | 収益性試算 | 中 | 32h |
| 9 | レポート生成 | PDF出力と結果共有 | ボリュームチェック、収益性試算 | 中 | 24h |

### 5.2 API実装タスクリスト

データの依存関係に基づき、以下の順序でAPI実装を進めます：

| タスク番号 | エンドポイント | メソッド | 説明 | 認証要否 | 対応フロントエンドページ | バックエンド実装 | テスト通過 | フロントエンド実装 |
|-----------|--------------|--------|------|----------|----------------------|--------------|------------|-----------------| 
| **1.1** | `/api/v1/auth/login` | POST | ユーザー認証とトークン取得 | 不要 | ログインページ | [x] | [x] | [x] |
| **1.2** | `/api/v1/auth/me` | GET | 認証ユーザー情報取得 | 必要 | ヘッダーコンポーネント | [x] | [x] | [x] |
| **1.3** | `/api/v1/auth/refresh` | POST | リフレッシュトークンによるアクセストークン更新 | 不要 | - | [x] | [x] | [x] |
| **1.4** | `/api/v1/auth/logout` | POST | ユーザーログアウト | 必要 | ヘッダーコンポーネント | [x] | [x] | [x] |
| **2.1** | `/api/v1/properties` | GET | 物件一覧の取得 | 必要 | ダッシュボード | [x] | [x] | [x] |
| **2.2** | `/api/v1/properties` | POST | 新規物件の登録 | 必要 | 物件登録ページ | [x] | [x] | [ ] |
| **2.3** | `/api/v1/geocode` | GET | 住所から緯度経度情報取得 | 必要 | 物件登録・編集ページ | [x] | [x] | [ ] |
| **3.1** | `/api/v1/properties/upload-survey` | POST | 測量図アップロードと形状抽出 | 必要 | 物件登録・編集ページ | [ ] | [ ] | [ ] |
| **3.2** | `/api/v1/properties/{id}/shape` | PUT | 敷地形状データの更新 | 必要 | 物件編集ページ | [ ] | [ ] | [ ] |
| **4.1** | `/api/v1/properties/{id}` | GET | 物件詳細情報の取得 | 必要 | 物件詳細ページ | [x] | [x] | [ ] |
| **4.2** | `/api/v1/properties/{id}` | PUT | 物件情報の更新 | 必要 | 物件編集ページ | [x] | [x] | [ ] |
| **4.3** | `/api/v1/properties/{id}` | DELETE | 物件の削除 | 必要 | 物件一覧・詳細ページ | [x] | [x] | [ ] |
| **4.4** | `/api/v1/properties/{id}/documents` | POST | 物件関連文書のアップロード | 必要 | 物件詳細ページ | [ ] | [ ] | [ ] |
| **4.5** | `/api/v1/properties/{id}/documents` | GET | 物件関連文書の一覧取得 | 必要 | 物件詳細ページ | [ ] | [ ] | [ ] |
| **5.1** | `/api/v1/analysis/volume-check` | POST | 建築可能ボリューム計算実行 | 必要 | ボリュームチェックページ | [ ] | [ ] | [ ] |
| **5.2** | `/api/v1/analysis/volume-check/{id}` | GET | ボリュームチェック結果取得 | 必要 | ボリュームチェックページ | [ ] | [ ] | [ ] |
| **6.1** | エンドポイントなし（フロントエンド処理） | - | 3Dモデル表示 | - | ボリュームチェックページ | [ ] | [ ] | [ ] |
| **7.1** | `/api/v1/analysis/profitability` | POST | 収益性試算実行 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **7.2** | `/api/v1/analysis/profitability/{id}` | GET | 収益性試算結果取得 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **8.1** | `/api/v1/analysis/scenarios` | POST | シナリオ作成 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **8.2** | `/api/v1/analysis/scenarios` | GET | シナリオ一覧取得 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **8.3** | `/api/v1/analysis/scenarios/{id}` | PUT | シナリオ更新 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **9.1** | エンドポイントなし（フロントエンド処理） | - | PDF出力 | - | ボリュームチェック・収益性試算ページ | [ ] | [ ] | [ ] |

このタスクリストは、バックエンド実装、テスト通過、フロントエンド実装の進捗を追跡するために使用します。各タスクの完了時にはチェックボックスにチェックを入れて進捗を可視化します。

### 5.3 次のタスクと引き継ぎ資料

#### 型定義の更新と物件基本管理機能の確認

型定義ファイル（`backend/src/types/index.ts`）を共有型定義（`shared/index.ts`）に完全に同期しました。主な更新内容は以下の通りです：

1. **基本型の追加**:
   - `PaginationParams`や`FilterOptions`などの共通ユーティリティ型を追加
   - 物件関連の型として`PropertyCreateData`と`PropertyUpdateData`を追加
   - 関連エンティティを含む`PropertyDetail`型を追加

2. **機能関連型の追加**:
   - ボリュームチェック関連の型（`BuildingParams`, `VolumeCheckResult`など）
   - 収益性試算関連の型（`FinancialParams`, `ProfitabilityResult`など）
   - シナリオ管理関連の型（`ScenarioParams`, `Scenario`など）
   - ドキュメント管理関連の型（`Document`, `HistoryEntry`など）

3. **APIパス定義の拡張**:
   - 物件管理関連の追加パス（`DOCUMENTS`, `DOCUMENT`, `HISTORY`など）
   - ボリュームチェック関連のパス（`ANALYSIS`セクション全体）

これらの型定義更新は実装に影響を与えず、バックエンドAPIの型安全性を向上させています。物件基本管理機能とジオコーディング機能は既に実装済みであり、以下の機能が利用可能です：

1. **物件基本管理エンドポイント**:
   - 物件一覧取得（GET /api/v1/properties）
   - 新規物件登録（POST /api/v1/properties）
   - 物件詳細取得（GET /api/v1/properties/{id}）
   - 物件情報更新（PUT /api/v1/properties/{id}）
   - 物件削除（DELETE /api/v1/properties/{id}）
   - ジオコーディング（GET /api/v1/geocode）

2. **物件データモデル**:
   - Mongooseスキーマとモデルの実装（PropertySchema、PropertyModel）
   - 敷地形状データの構造化（PropertyShape）
   - 許容建築面積の自動計算機能
   - フィルタリング、ページネーション、ソートに対応した物件一覧取得

3. **ジオコーディング機能**:
   - 住所から緯度経度情報を取得する機能
   - モック実装（将来的に実際のジオコーディングAPIと接続予定）

#### 次のタスク：敷地形状管理機能の実装

次のステップは敷地形状管理機能の実装です。主要な実装内容は以下の通りです：

##### 実装すべきエンドポイント
1. **測量図アップロード**: `POST /api/v1/properties/upload-survey`
   - 機能：測量図をアップロードし、自動的に敷地形状データを抽出
   - レスポンス：抽出された敷地形状データ（物件IDあればリンク）

2. **敷地形状データ更新**: `PUT /api/v1/properties/{id}/shape`
   - 機能：特定物件の敷地形状データを更新
   - レスポンス：更新された物件情報（敷地形状データを含む）

##### 実装要件

1. **ファイルアップロード処理**:
   - multerミドルウェアを使用して一時ファイル保存を実装
   - 対応ファイル形式：PDF、PNG、JPG（初期フェーズ）
   - ファイルサイズ上限の適切な設定（推奨: 10MB）
   - MIMEタイプチェックによるセキュリティ強化

2. **ファイル保存管理**:
   - アップロードファイルの一意のID生成（UUID推奨）
   - 階層構造によるファイル管理（物件ID/タイプ/ファイル名）
   - ファイルメタデータの保存（サイズ、タイプ、オリジナル名）
   - セキュアなURL生成と適切なアクセス制御

3. **形状データ抽出**:
   - 初期フェーズではモック実装も可
   - 長方形の場合：4点の座標を生成
   - 不整形の場合：シンプルな多角形として座標系列を生成
   - 抽出精度の評価と調整の仕組み

4. **データ連携**:
   - PropertyモデルのshapeDataフィールドとの連携
   - 形状データに基づいた敷地面積の自動再計算
   - 許容建築面積の自動更新処理

5. **バリデーションと例外処理**:
   - ファイルの存在チェックとタイプバリデーション
   - 物件存在チェックと所有権確認
   - 形状データの整合性チェック（閉じた多角形であることなど）
   - エラー発生時の適切なクリーンアップ処理

##### 技術的注意点

1. **セキュリティ考慮事項**:
   - ファイルの種類とサイズの厳格な検証
   - サーバー側でのウイルススキャン対応検討
   - ユーザー権限の適切な確認（物件所有者のみ更新可）
   - 一時ファイルの適切な削除処理

2. **パフォーマンス考慮事項**:
   - 非同期処理による大きなファイルの効率的な処理
   - 処理状況を通知する仕組みの検討
   - キャッシュ戦略の検討（同じファイルの再処理回避）

敷地形状管理機能の完了後は、ボリュームチェック機能の実装に進む準備が整います。この機能は本プロジェクトの中核となる機能であり、正確な敷地形状データを基にした建築ボリューム計算を可能にします。