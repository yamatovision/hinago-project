# API 仕様概要

**バージョン**: 1.0.0  
**最終更新日**: 2025-05-19  
**ステータス**: ドラフト  

## 1. API設計原則

HinagoProjectのAPIは、以下の設計原則に従い、一貫性のある直感的なインターフェースを提供します。

### 1.1 URLと命名規則

- **ベースURL**: `/api/v1/` （将来的な拡張を考慮してバージョン番号を含む）
- **リソース名**: 複数形で表現（例: `/api/v1/properties`）
- **階層関係**: 所有関係を`/`で表現（例: `/api/v1/properties/{propertyId}/documents`）
- **IDパターン**: リソースIDはURL内に含む（例: `/api/v1/properties/{propertyId}`）
- **クエリパラメータ**: フィルタリング、ソート、ページネーションに使用（例: `?status=active&sort=updatedAt:desc&page=1&limit=20`）
- **アクション**: 標準CRUDではないアクションは名詞または動詞で表現（例: `/api/v1/analysis/volume-check`）

### 1.2 HTTPメソッドの使用規則

| メソッド | 用途 | 特性 | 
|---------|------|------|
| GET | リソースの取得 | 安全、冪等 |
| POST | リソースの作成、複雑な処理の実行 | 非冪等 |
| PUT | リソースの完全な置換 | 冪等 |
| PATCH | リソースの部分更新 | 非冪等 |
| DELETE | リソースの削除 | 冪等 |

### 1.3 HTTPステータスコード

| コード | 説明 | 用途 |
|--------|------|------|
| 200 OK | 成功 | リクエスト成功、レスポンスにデータが含まれる |
| 201 Created | 作成成功 | 新しいリソースが作成された |
| 204 No Content | 内容なし | 成功したが返すべきデータがない（DELETE後など） |
| 400 Bad Request | 不正なリクエスト | バリデーションエラーや形式エラー |
| 401 Unauthorized | 認証エラー | 認証されていないアクセス |
| 403 Forbidden | 権限エラー | 認証されているが権限不足 |
| 404 Not Found | 未検出 | リソースが存在しない |
| 409 Conflict | 競合 | リソースの競合状態（同時編集など） |
| 422 Unprocessable Entity | 処理不可能 | リクエストの形式は正しいがセマンティックエラー |
| 500 Internal Server Error | サーバーエラー | サーバー側の予期しないエラー |

## 2. 共通レスポンス形式

すべてのAPIレスポンスは、一貫した構造を持ちます。

### 2.1 成功レスポンス

```json
{
  "success": true,
  "data": {
    // リクエストの結果データ
  },
  "meta": {
    // ページネーション情報やその他メタデータ（省略可能）
    "total": 52,
    "page": 1,
    "limit": 20,
    "totalPages": 3
  }
}
```

### 2.2 エラーレスポンス

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ",
    "details": {
      // 詳細なエラー情報（省略可能）
    }
  }
}
```

### 2.3 主要エラーコード

| エラーコード | 説明 |
|------------|------|
| VALIDATION_ERROR | リクエストデータのバリデーションに失敗 |
| RESOURCE_NOT_FOUND | 要求されたリソースが存在しない |
| UNAUTHORIZED | 認証が必要 |
| FORBIDDEN | 権限がない |
| CONFLICT | リソースの競合 |
| INTERNAL_ERROR | サーバー内部エラー |

## 3. 認証方式

APIの認証はJWTベースで行われます：

- **アクセストークン**: 15分の有効期限を持つJWTトークン
- **リフレッシュトークン**: 7日間の有効期限を持つトークン
- **トークンの送信**: Authorizationヘッダにベアラートークンとして付与
  ```
  Authorization: Bearer <access_token>
  ```
- **トークンの更新**: リフレッシュトークンを使用して新しいアクセストークンを取得
- **認証エラー**: 401 Unauthorizedステータスコードで返却

詳細は[認証API仕様書](/docs/api/auth.md)を参照してください。

## 4. データ取得パターン

### 4.1 フィールド選択

リクエストで取得するフィールドを指定できます：

```
GET /api/v1/properties?fields=id,name,status
```

### 4.2 ページネーション

ページネーションパラメータ：

```
GET /api/v1/properties?page=1&limit=20
```

レスポンスには以下のメタ情報が含まれます：

```json
{
  "meta": {
    "total": 52,
    "page": 1,
    "limit": 20,
    "totalPages": 3
  }
}
```

### 4.3 ソート

複数フィールドによるソート（昇順/降順）：

```
GET /api/v1/properties?sort=updatedAt:desc,name:asc
```

### 4.4 フィルタリング

フィールド値によるフィルタリング：

```
GET /api/v1/properties?status=active&created_after=2025-01-01
```

### 4.5 関連データ取得

関連エンティティの取得（深さ指定可能）：

```
GET /api/v1/properties?include=volumeChecks,documents
```

## 5. セキュリティ考慮事項

### 5.1 認証と認可

- すべてのAPIエンドポイントは、[アクセス制御マトリックス](/docs/architecture/access-control.md)に基づいた認証と認可のチェックを行います
- 認証例外: `/api/v1/auth/login`と`/api/v1/auth/refresh`のみ認証不要

### 5.2 レート制限

- 同一IPからの試行を10回/分に制限
- 認証エンドポイントには特に厳格な制限を適用

### 5.3 CSRF対策

- 認証済みセッションでは適切なCSRF対策を実装
- HTTPOnly Cookieの使用

### 5.4 機密データの取り扱い

- 機密データの返却時は一貫した隠蔽ポリシーを適用
- パスワードなどの機密値は決してレスポンスに含めない

## 6. バージョニング

APIバージョンはURLに含まれます（例: `/api/v1/properties`）。
バージョンの変更は以下の場合に行われます：

- **マイナーバージョン**: 後方互換性のある変更（フィールドの追加など）
- **メジャーバージョン**: 後方互換性のない変更（フィールドの削除、名前変更など）

## 7. リクエスト制限

- リクエスト本文の最大サイズ: 10MB
- ファイルアップロードの最大サイズ: 50MB（測量図など）
- ページネーションの最大limit値: 100

## 8. エンドポイント一覧

APIで提供される全エンドポイントの一覧は[エンドポイント一覧](/docs/api/endpoints.md)を参照してください。

## 9. リソース別API仕様

各リソースの詳細なAPI仕様は以下のドキュメントを参照してください：

- [認証API仕様](/docs/api/auth.md) - 認証関連のエンドポイント
- [物件API仕様](/docs/api/properties.md) - 物件管理のエンドポイント
- [ボリュームチェックAPI仕様](/docs/api/volume-check.md) - ボリュームチェック関連のエンドポイント