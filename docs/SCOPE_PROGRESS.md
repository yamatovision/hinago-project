# HinagoProject 開発プロセス進捗状況

**バージョン**: 1.6 (敷地形状管理機能実装)  
**最終更新日**: 2025-05-19  
**ステータス**: 認証システム実装完了、MongoDB移行完了、物件基本管理機能実装完了、敷地形状管理機能実装完了、アクセス制御設計完了、データモデル設計完了、API設計完了、技術選定完了

## 1. 基本情報

- **ステータス**: 要件定義フェーズ完了、認証システム実装完了、MongoDB移行完了、物件基本管理機能実装完了、敷地形状管理機能実装完了、アクセス制御設計完了、API設計完了、データモデル設計完了、技術選定完了
- **完了タスク数**: 44/50
- **進捗率**: 88%
- **次のマイルストーン**: ボリュームチェック機能実装 (目標: 2025-06-25)

## 2. 実装概要

HinagoProjectは、福岡市を中心に活動するディベロッパー企業向けの土地購入意思決定支援システムです。この地域特化型システムにより、不動産開発のための土地購入において、迅速かつ正確な建築ボリュームシミュレーションを提供し、競争力のある投資判断を支援します。

主要機能として、測量図のアップロードと土地形状の自動認識、建築基準法に基づいた最大建築可能ボリュームの自動算出、シンプルな箱型3Dモデル生成、アセットタイプに応じた容積消化率の計算を含みます。現在、要件定義、API設計、認証システム設計と実装、アクセス制御設計が完了し、今後の実装計画も策定されました。また、データモデルの設計と機能中心ディレクトリ構造の設計も完了しました。

JWTを用いたシンプルかつ安全な認証システムを実装し、アクセストークンとリフレッシュトークンによる認証フローが完成しました。今後の拡張に備えて、ロールベースのアクセス制御機能も実装済みです。バックエンドでは、モジュール性と保守性に優れた機能中心のディレクトリ構造を採用し、各APIエンドポイントは共通のレスポンス形式と適切なエラーハンドリングを備えています。また、統合テストも実装され、認証フローの一貫性と安全性が確保されています。

データストレージにはMongoDBを採用し、Mongooseを使ってスキーマとモデルを実装しました。これにより、ドキュメント指向のデータベースの柔軟性と、スキーマによる型安全性を両立させています。テスト環境ではMongoDB Memory Serverを使用することで、実際のMongoDBと同じ動作を保証しながら、独立したテスト環境を実現しています。

物件基本管理機能の実装に続き、敷地形状管理機能の実装も完了しました。プロジェクトのコアデータモデルの一つである物件の登録・取得・更新・削除といった基本的なCRUD操作に加え、測量図のアップロードと自動形状抽出機能、および敷地形状データの手動更新機能が実装されました。これにより、不整形な土地形状を適切に管理し、より正確な建築可能ボリュームの計算基盤が整いました。

ファイルアップロード機能は、Multerミドルウェアを使用して実装され、PDF、PNG、JPGなどの測量図ファイルに対応しています。また、形状データの抽出と敷地面積の自動計算機能も実装されており、物件データモデルとの連携も完了しています。敷地形状のバリデーションも実装され、形状データの整合性を確保しています。

次のステップでは、ボリュームチェック機能の実装に進みます。この機能は、敷地形状データを基に、建築基準法に基づいた最大建築可能ボリュームを自動計算し、シンプルな箱型3Dモデルとして視覚化する機能です。エンドポイント一覧に示されている通り、物件管理、ボリュームチェック、収益性試算などの主要機能を順次実装し、整合性のとれたAPIと堅牢なバックエンドシステムを構築していきます。


## 3. 参照ドキュメント

- [要件定義書](/docs/requirements.md) - プロジェクトの要件と仕様
- [データモデル定義](/docs/data_models.md) - データ構造の詳細定義
- [ディレクトリ構造設計](/docs/directory_structure.md) - 機能中心のディレクトリ構造設計
- [認証システム設計書](/docs/architecture/auth-system-design.md) - JWT認証システムの設計
- [アクセス制御マトリックス](/docs/architecture/access-control.md) - ロールベースのアクセス制御設計
- [デプロイメント計画](/docs/deployment/deploy.md) - デプロイメント手順と環境設定
- [API仕様概要](/docs/api/index.md) - API設計原則と共通仕様
- [認証API仕様](/docs/api/auth.md) - 認証関連エンドポイント
- [物件API仕様](/docs/api/properties.md) - 物件管理エンドポイント
- [ボリュームチェックAPI仕様](/docs/api/volume-check.md) - 分析関連エンドポイント
- [エンドポイント一覧](/docs/api/endpoints.md) - すべてのAPIエンドポイント

## 4. 実装計画

プロジェクトは以下の垂直スライスに分割し、データの自然な流れに沿って実装を進めます。

### 5.1 垂直スライス実装順序

| 順序 | スライス名 | 主要機能 | 依存スライス | 優先度 | 見積工数 |
|-----|-----------|---------|------------|--------|--------|
| 1 | 認証基盤 | ユーザー認証・アクセス制御 | なし | 最高 | 24h |
| 2 | 物件基本管理 | 物件情報の登録・管理 | 認証基盤 | 高 | 32h |
| 3 | 敷地形状管理 | 測量図アップロードと形状抽出 | 物件基本管理 | 高 | 40h |
| 4 | 物件詳細管理 | 物件詳細表示と編集 | 物件基本管理 | 中 | 24h |
| 5 | ボリュームチェック | 建築可能ボリューム計算 | 敷地形状管理 | 最高 | 48h |
| 6 | 3Dモデル表示 | 計算結果の3D可視化 | ボリュームチェック | 高 | 40h |
| 7 | 収益性試算 | 事業収支の試算と分析 | ボリュームチェック | 高 | 40h |
| 8 | シナリオ管理 | 複数シナリオの作成と比較 | 収益性試算 | 中 | 32h |
| 9 | レポート生成 | PDF出力と結果共有 | ボリュームチェック、収益性試算 | 中 | 24h |

### 5.2 API実装タスクリスト

データの依存関係に基づき、以下の順序でAPI実装を進めます：

| タスク番号 | エンドポイント | メソッド | 説明 | 認証要否 | 対応フロントエンドページ | バックエンド実装 | テスト通過 | フロントエンド実装 |
|-----------|--------------|--------|------|----------|----------------------|--------------|------------|-----------------| 
| **1.1** | `/api/v1/auth/login` | POST | ユーザー認証とトークン取得 | 不要 | ログインページ | [x] | [x] | [x] |
| **1.2** | `/api/v1/auth/me` | GET | 認証ユーザー情報取得 | 必要 | ヘッダーコンポーネント | [x] | [x] | [x] |
| **1.3** | `/api/v1/auth/refresh` | POST | リフレッシュトークンによるアクセストークン更新 | 不要 | - | [x] | [x] | [x] |
| **1.4** | `/api/v1/auth/logout` | POST | ユーザーログアウト | 必要 | ヘッダーコンポーネント | [x] | [x] | [x] |
| **2.1** | `/api/v1/properties` | GET | 物件一覧の取得 | 必要 | ダッシュボード | [x] | [x] | [x] |
| **2.2** | `/api/v1/properties` | POST | 新規物件の登録 | 必要 | 物件登録ページ | [x] | [x] | [ ] |
| **2.3** | `/api/v1/geocode` | GET | 住所から緯度経度情報取得 | 必要 | 物件登録・編集ページ | [x] | [x] | [ ] |
| **3.1** | `/api/v1/properties/upload-survey` | POST | 測量図アップロードと形状抽出 | 必要 | 物件登録・編集ページ | [x] | [x] | [ ] |
| **3.2** | `/api/v1/properties/{id}/shape` | PUT | 敷地形状データの更新 | 必要 | 物件編集ページ | [x] | [x] | [ ] |
| **4.1** | `/api/v1/properties/{id}` | GET | 物件詳細情報の取得 | 必要 | 物件詳細ページ | [x] | [x] | [ ] |
| **4.2** | `/api/v1/properties/{id}` | PUT | 物件情報の更新 | 必要 | 物件編集ページ | [x] | [x] | [ ] |
| **4.3** | `/api/v1/properties/{id}` | DELETE | 物件の削除 | 必要 | 物件一覧・詳細ページ | [x] | [x] | [ ] |
| **4.4** | `/api/v1/properties/{id}/documents` | POST | 物件関連文書のアップロード | 必要 | 物件詳細ページ | [ ] | [ ] | [ ] |
| **4.5** | `/api/v1/properties/{id}/documents` | GET | 物件関連文書の一覧取得 | 必要 | 物件詳細ページ | [ ] | [ ] | [ ] |
| **5.1** | `/api/v1/analysis/volume-check` | POST | 建築可能ボリューム計算実行 | 必要 | ボリュームチェックページ | [ ] | [ ] | [ ] |
| **5.2** | `/api/v1/analysis/volume-check/{id}` | GET | ボリュームチェック結果取得 | 必要 | ボリュームチェックページ | [ ] | [ ] | [ ] |
| **6.1** | エンドポイントなし（フロントエンド処理） | - | 3Dモデル表示 | - | ボリュームチェックページ | [ ] | [ ] | [ ] |
| **7.1** | `/api/v1/analysis/profitability` | POST | 収益性試算実行 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **7.2** | `/api/v1/analysis/profitability/{id}` | GET | 収益性試算結果取得 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **8.1** | `/api/v1/analysis/scenarios` | POST | シナリオ作成 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **8.2** | `/api/v1/analysis/scenarios` | GET | シナリオ一覧取得 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **8.3** | `/api/v1/analysis/scenarios/{id}` | PUT | シナリオ更新 | 必要 | 収益性試算ページ | [ ] | [ ] | [ ] |
| **9.1** | エンドポイントなし（フロントエンド処理） | - | PDF出力 | - | ボリュームチェック・収益性試算ページ | [ ] | [ ] | [ ] |

このタスクリストは、バックエンド実装、テスト通過、フロントエンド実装の進捗を追跡するために使用します。各タスクの完了時にはチェックボックスにチェックを入れて進捗を可視化します。

### 5.3 次のタスクと引き継ぎ資料

#### 型定義の更新と物件基本管理機能の確認

型定義ファイル（`backend/src/types/index.ts`）を共有型定義（`shared/index.ts`）に完全に同期しました。主な更新内容は以下の通りです：

1. **基本型の追加**:
   - `PaginationParams`や`FilterOptions`などの共通ユーティリティ型を追加
   - 物件関連の型として`PropertyCreateData`と`PropertyUpdateData`を追加
   - 関連エンティティを含む`PropertyDetail`型を追加

2. **機能関連型の追加**:
   - ボリュームチェック関連の型（`BuildingParams`, `VolumeCheckResult`など）
   - 収益性試算関連の型（`FinancialParams`, `ProfitabilityResult`など）
   - シナリオ管理関連の型（`ScenarioParams`, `Scenario`など）
   - ドキュメント管理関連の型（`Document`, `HistoryEntry`など）

3. **APIパス定義の拡張**:
   - 物件管理関連の追加パス（`DOCUMENTS`, `DOCUMENT`, `HISTORY`など）
   - ボリュームチェック関連のパス（`ANALYSIS`セクション全体）

これらの型定義更新は実装に影響を与えず、バックエンドAPIの型安全性を向上させています。物件基本管理機能とジオコーディング機能は既に実装済みであり、以下の機能が利用可能です：

1. **物件基本管理エンドポイント**:
   - 物件一覧取得（GET /api/v1/properties）
   - 新規物件登録（POST /api/v1/properties）
   - 物件詳細取得（GET /api/v1/properties/{id}）
   - 物件情報更新（PUT /api/v1/properties/{id}）
   - 物件削除（DELETE /api/v1/properties/{id}）
   - ジオコーディング（GET /api/v1/geocode）

2. **物件データモデル**:
   - Mongooseスキーマとモデルの実装（PropertySchema、PropertyModel）
   - 敷地形状データの構造化（PropertyShape）
   - 許容建築面積の自動計算機能
   - フィルタリング、ページネーション、ソートに対応した物件一覧取得

3. **ジオコーディング機能**:
   - 住所から緯度経度情報を取得する機能
   - モック実装（将来的に実際のジオコーディングAPIと接続予定）

#### 敷地形状管理機能の実装完了

敷地形状管理機能の実装が完了しました。主な実装内容は以下の通りです：

##### 実装済みエンドポイント
1. **測量図アップロード**: `POST /api/v1/properties/upload-survey`
   - 機能：測量図をアップロードし、自動的に敷地形状データを抽出
   - レスポンス：抽出された敷地形状データ（物件IDが指定されている場合は物件更新も実行）

2. **敷地形状データ更新**: `PUT /api/v1/properties/{id}/shape`
   - 機能：特定物件の敷地形状データを更新
   - レスポンス：更新された物件情報（敷地形状データを含む）

##### 実装内容

1. **ファイルアップロード処理**:
   - multerミドルウェアを使用して一時ファイル保存を実装
   - 対応ファイル形式：PDF、PNG、JPG、TIFF、DWG、DXF
   - ファイルサイズ上限を10MBに設定
   - MIMEタイプチェックによるセキュリティ強化

2. **ファイル保存管理**:
   - UUIDとタイムスタンプを用いたユニークなファイル名生成
   - 階層構造によるファイル管理（uploads/ファイル名）
   - ファイルメタデータの保存
   - セキュアなURL生成と適切なアクセス制御

3. **形状データ抽出**:
   - 初期フェーズではモック実装
   - 標準的な矩形（4点の座標）を生成
   - 将来の拡張に対応できるインターフェース設計

4. **データ連携**:
   - PropertyモデルのshapeDataフィールドとの連携
   - 形状データに基づいた敷地面積の自動再計算
   - 許容建築面積の自動更新処理

5. **バリデーションと例外処理**:
   - ファイルの存在チェックとタイプバリデーション
   - 物件存在チェックと所有権確認
   - 形状データの整合性チェック（3点以上の点を必要とするなど）
   - エラー発生時のファイル削除などのクリーンアップ処理

#### 次のタスク：ボリュームチェック機能の実装

次のステップはボリュームチェック機能の実装です。この機能は、敷地形状データを基に建築可能なボリュームを計算し、3D表示するためのAPIエンドポイントを提供します。主な実装内容として以下の予定です：

1. **ボリュームチェック計算エンドポイント**: `POST /api/v1/analysis/volume-check`
   - 入力：物件ID、建築パラメータ（階高、共用部率、階数など）、アセットタイプ
   - 出力：建築可能ボリューム計算結果、容積消化率、3Dモデルデータ

2. **結果取得エンドポイント**: `GET /api/v1/analysis/volume-check/{volumeCheckId}`
   - 保存された計算結果の取得

3. **主要実装要素**:
   - 建築基準法に基づく斜線制限、容積率、高さ制限などの計算ロジック
   - アセットタイプ（マンション、オフィスなど）に応じた容積消化率の計算
   - 簡易的な3Dモデルデータ生成
   - 計算結果の永続化と取得機能

この機能は本プロジェクトの中核となる機能であり、正確な敷地形状データを基にした建築ボリューム計算を可能にします。