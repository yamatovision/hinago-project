# 建物形状最適化 要件定義書

## 1. 概要
敷地形状に応じた建物形状の自動生成と最適化機能を実装する。現在の単純な矩形表示から、実際の建築計画に即した高度な形状生成へ移行する。

## 2. 現状の課題
- 敷地形状：座標データから正確な不整形地として表示されている（✅完了）
- 建物形状：敷地形状に関わらず単純な矩形ボックスとして表示（❌要改善）
- 建築規制：考慮されていない（❌要改善）

## 3. 機能要件

### 3.1 基本的な建物形状生成
- **要件ID**: BSO-001
- **内容**: 敷地境界線から内側にオフセットした建物形状を生成
- **詳細**:
  - 敷地形状の全ての境界線から一定距離内側に建物外形を生成
  - ポリゴンオフセットアルゴリズムを使用
  - 建築面積を自動計算

### 3.2 境界線種別の自動判定
- **要件ID**: BSO-002
- **内容**: 道路境界線と隣地境界線を自動判定
- **詳細**:
  - 道路幅員情報から道路境界線を特定
  - 各境界線に応じたセットバック距離を適用
  - 道路境界：4m以上（建築基準法）
  - 隣地境界：民法上の離隔距離（50cm以上）

### 3.3 斜線制限への対応
- **要件ID**: BSO-003
- **内容**: 各種斜線制限に応じた階段状セットバック
- **詳細**:
  - 道路斜線制限：道路境界線からの距離と高さの関係
  - 隣地斜線制限：隣地境界線からの立ち上がり
  - 北側斜線制限：北側隣地への日照確保
  - 階層ごとに異なるセットバックを適用

### 3.4 日影規制最適化
- **要件ID**: BSO-004
- **内容**: 日影規制を満たしつつ容積を最大化
- **詳細**:
  - 測定面（4m、6.5m）での日影時間を計算
  - 規制時間（4時間/2.5時間、5時間/3時間）内に収める
  - 建物高さと形状を自動調整
  - 冬至日（12月22日）の日影をシミュレーション

### 3.5 容積率最大化
- **要件ID**: BSO-005
- **内容**: 与えられた制約内で延床面積を最大化
- **詳細**:
  - 建蔽率制限内で各階の面積を最適化
  - 容積率制限まで階数を積み上げ
  - 斜線制限による削り取りを考慮
  - 共用部分（階段、エレベーター等）を考慮

### 3.6 眺望・採光の最適化
- **要件ID**: BSO-006
- **内容**: 住環境の質を考慮した配置
- **詳細**:
  - 主要な居室の南向き配置
  - 眺望の良い方向への開口部配置
  - プライバシーを考慮した開口部配置
  - バルコニー・テラスの最適配置

## 4. 技術要件

### 4.1 アルゴリズム
- ポリゴンオフセット：Clipper.js または同等のライブラリ
- 日影計算：太陽位置計算アルゴリズム（SunCalc.js等）
- 最適化：遺伝的アルゴリズムまたは勾配降下法
- 3D形状生成：Three.js ExtrudeGeometry

### 4.2 データ構造
```typescript
interface BuildingShape {
  floors: Floor[];              // 階層ごとの形状
  totalHeight: number;          // 建物全体の高さ
  buildingArea: number;         // 建築面積
  totalFloorArea: number;       // 延床面積
  volumeEfficiency: number;     // 容積効率
}

interface Floor {
  level: number;                // 階数
  height: number;               // 階高
  shape: BoundaryPoint[];       // 平面形状
  area: number;                 // 床面積
  setback: SetbackInfo;         // セットバック情報
}

interface SetbackInfo {
  north: number;                // 北側セットバック
  south: number;                // 南側セットバック
  east: number;                 // 東側セットバック
  west: number;                 // 西側セットバック
  reason: SetbackReason[];      // セットバック理由
}

enum SetbackReason {
  ROAD_SETBACK = "道路境界線",
  NEIGHBOR_SETBACK = "隣地境界線",
  SLOPE_RESTRICTION = "斜線制限",
  SHADOW_REGULATION = "日影規制",
  DISTRICT_PLAN = "地区計画"
}
```

### 4.3 パフォーマンス要件
- 形状生成：1秒以内
- 日影計算：5秒以内
- 最適化計算：10秒以内
- リアルタイム更新：パラメータ変更時に即座に反映

## 5. UI/UX要件

### 5.1 表示機能
- 3Dビューでの建物形状表示
- 階層ごとの平面図表示
- セットバック理由の可視化
- 日影の動的表示（時間変化）

### 5.2 操作機能
- セットバック距離の手動調整
- 階数の増減
- 最適化パラメータの調整
- 制約条件の有効/無効切り替え

### 5.3 出力機能
- 建物概要データのエクスポート
- 3Dモデルのダウンロード（glTF形式）
- 規制チェックレポートの生成

## 6. 実装フェーズ

### Phase 1: 基本実装（1週間）
- ポリゴンオフセットによる基本形状生成
- 一律セットバックの適用
- 建築面積の自動計算

### Phase 2: 規制対応（2週間）
- 境界線種別の判定
- 斜線制限の実装
- 階段状セットバックの生成

### Phase 3: 高度な最適化（3週間）
- 日影規制シミュレーション
- 容積率最大化アルゴリズム
- 眺望・採光の最適化

## 7. 成功基準
- 不整形地でも適切な建物形状が生成される
- 全ての建築規制をクリアする
- 容積率の95%以上を実現
- ユーザーが手動調整なしで実用的な計画が得られる

## 8. 制約事項
- ブラウザでの動作を前提（重い計算は避ける）
- モバイル端末では簡易表示に切り替え
- 既存のデータ構造との互換性を維持

## 9. 将来の拡張性
- AI/機械学習による最適化
- 構造計算との連携
- BIMデータへのエクスポート
- VR/ARでの表示